/* ---------- QR helper (theme-aware) ---------- */
function makeQRCanvas(text, size=260){
  const c = document.createElement('canvas'); c.width = c.height = size;
  return new Promise((resolve,reject)=>{
    // keep standard black QR on white for scan reliability
    QRCode.toCanvas(
      c, text || location.href,
      { width:size, margin:1, errorCorrectionLevel:'Q', color:{ dark:'#111', light:'#fff' } },
      err => err ? reject(err) : resolve(c)
    );
  });
}

/* ---------- text helpers ---------- */
function wrapLines(ctx, text, maxW){
  const words = (text||'').split(/\s+/); const lines=[]; let line='';
  for(let i=0;i<words.length;i++){
    const test=line+words[i]+' ';
    if(ctx.measureText(test).width>maxW && line){ lines.push(line.trim()); line=words[i]+' '; }
    else line=test;
  }
  if(line) lines.push(line.trim());
  return lines;
}

/* ---------- stickers (cute but subtle) ---------- */
function drawStickers(ctx, W, H, type){
  ctx.save();
  if(type==='hearts'){
    const colors=['#ff9ac3','#ffd6e9','#fff0f6'];
    for(let i=0;i<14;i++){
      ctx.fillStyle = colors[i%colors.length];
      const x = Math.random()*W, y = Math.random()*H*0.35 + 10;
      ctx.globalAlpha = 0.18 + Math.random()*0.18;
      ctx.beginPath();
      ctx.moveTo(x,y);
      ctx.arc(x-6,y,6,0,Math.PI,true);
      ctx.arc(x+6,y,6,0,Math.PI,true);
      ctx.lineTo(x,y+10); ctx.closePath(); ctx.fill();
    }
  } else if(type==='daisies'){
    const petal = (x,y,r,c)=>{ ctx.fillStyle=c; for(let k=0;k<6;k++){ ctx.beginPath(); ctx.ellipse(x,y,r*0.55,r, k*Math.PI/3,0,Math.PI*2); ctx.fill(); } ctx.beginPath(); ctx.fillStyle='#ffd86e'; ctx.arc(x,y,r*0.35,0,Math.PI*2); ctx.fill(); };
    for(let i=0;i<10;i++){ const x= 40+Math.random()*(W-80), y= 30+Math.random()*80; ctx.globalAlpha=.22; petal(x,y,8,['#fff','#fff','#fdfdfd'][i%3]); }
  } else if(type==='ribbons'){
    ctx.globalAlpha=.12; ctx.fillStyle='#b68b2e';
    ctx.fillRect(32,24,120,10); ctx.fillRect(W-160,18,120,10);
  } else if(type==='stars'){
    const dots=160; ctx.globalAlpha=.2; ctx.fillStyle='#ffffff';
    for(let i=0;i<dots;i++){ ctx.fillRect(Math.random()*W, Math.random()*H*0.5, 2, 2); }
  }
  ctx.restore();
}

/* ---------- main painter ---------- */
async function drawPostcard(opts){
  const {
    themeKey='classic',
    title='A little note for you',
    message='',
    url=location.href,
    footer='',
    fontMode='auto',
    format='card'     // card | story | square
  } = opts;

  const theme = THEMES[themeKey] || THEMES.classic;
  const canvas = document.getElementById('pcCanvas') || document.getElementById('card');
  const ctx = canvas.getContext('2d');

  // Sizes
  let W=1200, H=720;
  if(format==='story'){ W=1080; H=1920; }
  if(format==='square'){ W=1080; H=1080; }
  canvas.width=W; canvas.height=H;
  const k = W/1200;                       // scale factor

  // Background gradient
  const bg = ctx.createLinearGradient(0,0,0,H);
  bg.addColorStop(0, theme.bgStops[0]); bg.addColorStop(1, theme.bgStops[1]);
  ctx.fillStyle = bg; ctx.fillRect(0,0,W,H);

  // Confetti/bokeh
  theme.confetti.forEach(col=>{
    ctx.fillStyle = col;
    for(let i=0;i<60;i++){
      const r = Math.random()*2 + 1;
      ctx.globalAlpha = 0.12 + Math.random()*0.15;
      ctx.beginPath();
      ctx.arc(Math.random()*W, Math.random()*H, r, 0, Math.PI*2);
      ctx.fill();
    }
  });
  ctx.globalAlpha = 1;

  // Panel
  const PAD = Math.round(40*k), R = Math.round(22*k), innerPadX = Math.round(26*k);
  const panelX = PAD, panelY = PAD, panelW = W-PAD*2, panelH = H-PAD*2;

  // shadow
  ctx.save();
  ctx.shadowColor = 'rgba(0,0,0,.28)'; ctx.shadowBlur = 36*k; ctx.shadowOffsetY = 12*k;
  roundRect(ctx, panelX, panelY, panelW, panelH, R, true, false);
  ctx.restore();

  // actual fill + stroke
  ctx.fillStyle = theme.panelBg;
  roundRect(ctx, panelX, panelY, panelW, panelH, R, true, false);
  ctx.strokeStyle = theme.panelStroke; ctx.lineWidth = Math.max(1,2*k);
  roundRect(ctx, panelX, panelY, panelW, panelH, R, false, true);

  // stickers floating in upper half
  drawStickers(ctx, W, Math.min(panelH, H*0.55), theme.stickers);

  // Title (gradient fill)
  const tg = ctx.createLinearGradient(panelX,0,panelX+panelW,0);
  (theme.titleGrad||[theme.accent]).forEach((c,i,a)=> tg.addColorStop(i/(a.length-1||1), c));
  ctx.fillStyle = tg;
  ctx.textAlign='left'; ctx.textBaseline='top';
  ctx.font = `800 ${Math.round(46*k)}px "Fraunces","Playfair Display",serif`;
  ctx.fillText(title, panelX+innerPadX, panelY+Math.round(28*k));

  // divider line
  ctx.strokeStyle = theme.accent; ctx.lineWidth = Math.max(1.5,2*k);
  line(ctx, panelX+innerPadX, panelY+Math.round(82*k), panelX+panelW-innerPadX, panelY+Math.round(82*k));

  // Message font selection
  const mode = (fontMode==='auto') ? (theme.defaultFont||'clean') : fontMode;
  let msgFont;
  if(mode==='clean')   msgFont = `600 ${Math.round(28*k)}px "Quicksand","Poppins",system-ui`;
  if(mode==='cursive') msgFont = `400 ${Math.round(36*k)}px "Pacifico","Satisfy",cursive`;
  if(mode==='elegant') msgFont = `400 ${Math.round(40*k)}px "Great Vibes","Sacramento",cursive`;

  // Message block
  ctx.fillStyle = theme.ink; ctx.font = msgFont; ctx.textAlign = 'left';
  const textX = panelX+innerPadX;
  const textTop = panelY+Math.round(110*k);
  const textMax = panelW - innerPadX*2 - Math.round(320*k);

  // soft heart glyph between text lines (cute, optional)
  const lines = wrapLines(ctx, message, textMax);
  let yy = textTop, lh = (mode==='clean'? 40*k : 46*k);
  lines.forEach((l,i)=>{ ctx.fillText(l, textX, yy); yy += lh; });

  // Footer anchored to bottom inside panel
  if(footer){
    ctx.fillStyle = theme.sub;
    ctx.font = `600 ${Math.round(22*k)}px "Quicksand",sans-serif`;
    const fLines = wrapLines(ctx, footer, panelW - innerPadX*2);
    const fLH = Math.round(34*k);
    const total = fLines.length * fLH;
    let fy = panelY + panelH - innerPadX - total;
    fLines.forEach(l => { ctx.fillText(l, panelX+innerPadX, fy); fy += fLH; });
  }

  // QR area (right)
  const qr = await makeQRCanvas(url, Math.round(280*k));
  const qrX = panelX + panelW - innerPadX - qr.width;
  const qrY = panelY + Math.round(110*k);

  // QR white tile with rounded corners
  ctx.fillStyle = '#fff';
  roundRect(ctx, qrX-12, qrY-12, qr.width+24, qr.height+24, 12*k, true, false);
  ctx.drawImage(qr, qrX, qrY);

  // QR caption
  ctx.fillStyle = theme.sub;
  ctx.font = `600 ${Math.round(18*k)}px "Quicksand",sans-serif`;
  ctx.textAlign = 'center';
  ctx.fillText('Scan to open', qrX + qr.width/2, qrY + qr.height + Math.round(26*k));
}

/* ----- basic helpers ----- */
function roundRect(ctx, x, y, w, h, r, fill, stroke){
  if (w < 2 * r) r = w / 2; if (h < 2 * r) r = h / 2;
  ctx.beginPath();
  ctx.moveTo(x+r, y);
  ctx.arcTo(x+w, y,   x+w, y+h, r);
  ctx.arcTo(x+w, y+h, x,   y+h, r);
  ctx.arcTo(x,   y+h, x,   y,   r);
  ctx.arcTo(x,   y,   x+w, y,   r);
  ctx.closePath();
  if (fill) ctx.fill();
  if (stroke) ctx.stroke();
}
function line(ctx, x1,y1,x2,y2){ ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke(); }

/* ---------- wire buttons ---------- */
async function generatePostcard(){
  const themeKey = (document.getElementById('pcTheme') || {}).value || 'classic';
  const fontMode = (document.getElementById('pcFont')  || {}).value || 'auto';
  const title    = (document.getElementById('title')   || {}).value || 'A little note for you';
  const message  = (document.getElementById('msg')     || {}).value || '';
  const url      = (document.getElementById('url')     || {}).value || location.href;
  const footer   = (document.getElementById('footer')  || {}).value || '';
  const format   = (document.getElementById('fmt')     || {}).value || 'card';

  await drawPostcard({ themeKey, title, message, url, footer, fontMode, format });
}
function downloadPNG(){
  const c = document.getElementById('pcCanvas') || document.getElementById('card');
  const a = document.createElement('a'); a.href = c.toDataURL('image/png'); a.download = 'postcard.png'; a.click();
}
(document.getElementById('render')   || document.getElementById('pcGenerate'))?.addEventListener('click', generatePostcard);
(document.getElementById('download') || document.getElementById('pcDownload'))?.addEventListener('click', downloadPNG);

/* initial render */
generatePostcard();
