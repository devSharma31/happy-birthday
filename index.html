
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>for Shruti ‚Äî a small night (v1.1)</title>
<meta name="description" content="A birthday page for Shruti‚Äîblessings, silly-boy-trying energy, her photos, 3D stardust and heart fireworks‚Äîwith quiet spiritual vibes.">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Poppins:wght@400;600;800&family=Caveat:wght@600&display=swap" rel="stylesheet">
<meta name="theme-color" content="#0c1022">

<style>
:root{
  --bg1:#0c1022; --bg2:#14102e; --ink:#eef2ff; --muted:#cdd5f9; --accent:#ff8fb1; --edge:rgba(255,255,255,.12);
  --petal:#ffc8dd; --gold:#f6d06e; --card:#10182a; --card2:#0f1730;
}
.gulabi{ --bg1:#1a0b24; --bg2:#2a1345; --accent:#ff96c8; --ink:#fff4fa; --muted:#ffd9e8; --petal:#ffd1e1; --card:#1a1430; --card2:#23193f }
.denim { --bg1:#0b1322; --bg2:#0b1b33; --accent:#85a9ff; --ink:#eaf2ff; --muted:#cfe0ff; --petal:#c7d7ff; --card:#0c1629; --card2:#0e1d36 }

html,body{height:100%} html{scroll-behavior:smooth}
@media (prefers-reduced-motion:reduce){
  *{animation-duration:.001ms!important;animation-iteration-count:1!important;transition-duration:.001ms!important;scroll-behavior:auto!important}
}
body{
  margin:0; color:var(--ink);
  font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  background:
   radial-gradient(900px 440px at 50% -12%, rgba(155,211,255,.14), transparent 60%),
   linear-gradient(180deg,var(--bg1),var(--bg2));
  overflow-x:hidden;
}
h1,h2{font-family:"Playfair Display",serif}
.container{max-width:980px;margin:0 auto;padding:0 16px}
.section{min-height:100vh;display:grid;place-items:center;padding:84px 0;position:relative}
.center{text-align:center}
.muted{color:var(--muted)}
a.btn,button.btn{appearance:none;border:0;border-radius:16px;padding:12px 18px;font-weight:800;cursor:pointer;color:#0c0f17;
  background:linear-gradient(90deg,var(--accent),#c9a7ff);box-shadow:0 12px 24px rgba(0,0,0,.28)}
.btn:active{transform:translateY(1px) scale(.99)}
.soft{border:1px solid var(--edge);border-radius:18px;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));box-shadow:0 18px 44px rgba(0,0,0,.35)}
.hint{font-size:12px;color:var(--muted)}
.sig{position:fixed;left:12px;top:12px;font-size:12px;color:var(--muted);z-index:10}
.sig b{color:var(--accent)}
.mood{position:fixed;right:12px;top:12px;display:flex;gap:8px;z-index:10}
.mood button{width:26px;height:26px;border-radius:50%;border:2px solid rgba(255,255,255,.5);cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,.25)}
.mood .n{background:#1c1f2d}.mood .g{background:#ff8fb1}.mood .d{background:#85a9ff}
.mood .t3d{background:linear-gradient(135deg,#ffd2ea,#b9c8ff); color:#111; font-size:12px; width:auto; height:auto; padding:4px 8px; border-radius:12px; border:1px solid rgba(255,255,255,.5)}

/* Stars + sky */
.stars{position:fixed;inset:0;pointer-events:none;z-index:-2;opacity:.85;
  background:
    radial-gradient(2px 2px at 18% 28%,#fff,transparent 60%),
    radial-gradient(2px 2px at 78% 22%,#fff,transparent 60%),
    radial-gradient(1.5px 1.5px at 32% 72%,#fff,transparent 60%),
    radial-gradient(1.5px 1.5px at 64% 64%,#fff,transparent 60%),
    radial-gradient(1.5px 1.5px at 52% 48%,#fff,transparent 60%);
  animation:twinkle 6s ease-in-out infinite alternate}
@keyframes twinkle{from{opacity:.6}to{opacity:1}}
#trail,#nameConstellation{position:fixed;inset:0;pointer-events:none;z-index:0;mix-blend-mode:screen;opacity:.95}

/* Petals */
#petals{position:fixed;inset:0;pointer-events:none;z-index:1}
.petal{position:fixed;top:-40px;width:14px;height:14px;background:radial-gradient(circle at 30% 30%,#fff,transparent 60%),var(--petal);
  border-radius:42% 58% 58% 42%/64% 62% 38% 36%;opacity:.75;filter:drop-shadow(0 8px 10px rgba(255,200,221,.25))}

/* Landing */
.title{font-size:clamp(24px,6vw,40px);line-height:1.28;margin:0 0 12px}
.lead{max-width:740px;margin:0 auto 16px}
.cta{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}

/* Diya */
.diya{width:140px;height:140px;position:relative;filter:drop-shadow(0 28px 40px rgba(246,208,110,.22));transform:translateY(6px) scale(.96);transition:.7s ease}
.bowl{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);width:130px;height:56px;background:radial-gradient(130px 56px at 50% 0%,#6b3b1b,#341c0f 70%);border-radius:80px 80px 30px 30px/40px 40px 30px 30px;box-shadow:inset 0 10px 24px rgba(255,255,255,.06)}
.oil{position:absolute;bottom:32px;left:50%;transform:translateX(-50%);width:110px;height:18px;background:radial-gradient(110px 18px at 50% 60%,#2c1409,#120803 70%);border-radius:999px}
.flame{position:absolute;left:50%;bottom:52px;transform:translateX(-50%) rotate(-2deg);width:20px;height:34px;background:radial-gradient(ellipse at 50% 20%,#fff6b0,#ffd275 40%,rgba(255,120,64,.9) 70%,rgba(255,120,64,0) 75%);border-radius:50%/70% 70% 30% 30%;opacity:0}
.glow{position:absolute;left:50%;bottom:52px;transform:translateX(-50%);width:110px;height:110px;border-radius:50%;background:radial-gradient(closest-side,rgba(255,214,110,.42),rgba(255,214,110,0));opacity:0}
.lit{transform:translateY(0) scale(1)}
.lit .flame{animation:flicker .18s infinite alternate .1s;opacity:1}
.lit .glow{animation:glow 1.2s ease-in-out infinite alternate .1s;opacity:1}
@keyframes flicker{from{transform:translateX(-50%) rotate(-2deg) scaleY(1)}to{transform:translateX(-50%) rotate(2deg) scaleY(1.07)}}
@keyframes glow{from{transform:translateX(-50%) scale(.9)}to{transform:translateX(-50%) scale(1.05)}}

/* Balloons + modal (slower, aligned, non-overlap) */
.balloon-area{position:relative;height:64vh;max-height:640px;width:100%;overflow:hidden;border-radius:18px;border:1px solid var(--edge);
  background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.02));box-shadow:inset 0 1px 0 rgba(255,255,255,.04)}
.balloon{
  --c:#ff9ccc; --delay:0; --x:10;
  position:absolute; bottom:-150px; left:calc(var(--x)*1%);
  width:88px; height:112px; border-radius:50% 50% 45% 45%/55% 55% 45% 45%;
  background:radial-gradient(circle at 30% 30%,#fff8,transparent 60%),var(--c);
  box-shadow:inset -10px -16px 24px rgba(0,0,0,.2);
  animation:floatUp 26s linear infinite; animation-delay:calc(var(--delay)*1s);
  display:grid;place-items:center;color:#0c0e1a;font-weight:900;text-shadow:0 1px 0 #ffffff88;cursor:pointer;
  will-change: transform;
}
.balloon::after{content:"";position:absolute;width:2px;height:140px;background:rgba(255,255,255,.3);left:50%;bottom:-140px}
.balloon span{background:#fff;padding:6px 10px;border-radius:999px;font-size:14px}
@keyframes floatUp{from{transform:translateY(0)}to{transform:translateY(-105vh)}}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:50}
.modal.show{display:flex}
.dialog{max-width:560px;margin:16px;background:linear-gradient(180deg,#0e1628,#0c1323);border:1px solid var(--edge);border-radius:18px;padding:18px;text-align:center;box-shadow:0 18px 40px rgba(0,0,0,.44)}
.dialog h4{margin:.25rem 0 .5rem;font-size:20px}
.dialog p{margin:0;color:var(--muted)}

/* Greeting cards ‚Äî FLIP */
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px;width:min(100%,980px)}
.flip-card{perspective:1200px}
.flip-inner{position:relative;transform-style:preserve-3d;transition:transform .6s cubic-bezier(.2,.7,.2,1)}
.flip-card.open .flip-inner{transform:rotateY(180deg)}
.face{backface-visibility:hidden;border-radius:16px;border:1px solid var(--edge);box-shadow:0 16px 38px rgba(0,0,0,.35)}
.face.front{padding:18px;background:linear-gradient(180deg,var(--card),var(--card2))}
.face.back{padding:18px;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));position:absolute;inset:0;transform:rotateY(180deg)}
.face h3{margin:.3rem 0 .4rem;font-family:"Caveat",cursive;font-size:24px;color:var(--accent)}
.face p{margin:.2rem 0 .2rem;line-height:1.7}
.openHint{font-size:12px;color:var(--muted);margin-top:6px}

/* Spotlight */
.gallery{display:grid;gap:12px}
.hero{position:relative;border-radius:20px;overflow:hidden;height:min(60vh,520px)}
.hero img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;transform:scale(1.06);animation:ken 14s ease-in-out infinite}
@keyframes ken{0%{transform:scale(1.04)}50%{transform:scale(1.1) translate(-1%,-1%)}100%{transform:scale(1.04)}}
.hero canvas#stardust { position:absolute; inset:0; pointer-events:none; mix-blend-mode:screen; }

/* Polaroids */
.polaroids{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px}
.pol{height:160px;border-radius:12px;overflow:hidden;border:2px solid transparent;background:#fff0;cursor:grab;transform:rotate(var(--r,0deg)) scale(1);transition:transform .2s}
.pol img{width:100%;height:100%;object-fit:cover}
.pol.active{border-color:var(--accent)}
.lightbox{display:none;position:fixed;inset:0;background:rgba(0,0,0,.86);z-index:60;align-items:center;justify-content:center}
.lightbox img{max-width:92vw;max-height:86vh;border-radius:14px;border:1px solid var(--edge);box-shadow:0 22px 60px rgba(0,0,0,.6)}
.lightbox .x{position:absolute;top:12px;right:12px}

/* Lines */
.carousel{display:grid;gap:10px;justify-items:center}
.slide{max-width:760px;text-align:center;padding:16px;border-radius:16px;border:1px solid var(--edge);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03))}
.nav{display:flex;gap:10px;justify-content:center}

/* Final */
#fire{position:absolute;inset:0;pointer-events:none}
#fireEnter{position:fixed;inset:0;pointer-events:none;z-index:9;opacity:0;transition:opacity .4s}
.final p{font-size:clamp(18px,3.6vw,22px);line-height:1.6}
@media (max-width:560px){ .polaroids{grid-template-columns:repeat(2,1fr)} }

/* Welcome Gate */
body.gated { overflow:hidden; overscroll-behavior:contain; touch-action:none; }
.gate{position:fixed; inset:0; z-index:9999; display:flex; align-items:center; justify-content:center;
  background: radial-gradient(900px 440px at 50% -12%, rgba(155,211,255,.18), transparent 60%),
              linear-gradient(180deg,var(--bg1),var(--bg2));
  backdrop-filter: blur(6px); transition: opacity .45s ease; animation: gateFade .45s ease both;}
.gate.hide{opacity:0;pointer-events:none}
.gate-card{width:min(560px,92vw); padding:18px; text-align:center; border-radius:18px; border:1px solid var(--edge);
  background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03)); box-shadow:0 22px 48px rgba(0,0,0,.45);
  transform: translateY(6px) scale(.94); animation: gatePop .45s cubic-bezier(.2,.75,.2,1) .05s both;}
.gate-card h1{margin:.2rem 0 .3rem;font-size:clamp(22px,5.2vw,32px)}
.gate-card p{margin:.2rem 0;color:var(--muted)}
.gate-actions{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:12px}
@keyframes gateFade { from{opacity:0} to{opacity:1} }
@keyframes gatePop  { from{opacity:0; transform:translateY(10px) scale(.94)} to{opacity:1; transform:none} }

/* Three overlay for ring */
#ring3d{display:none; position:fixed; inset:0; background:rgba(0,0,0,.75); z-index:90; align-items:center; justify-content:center}
#ring3d .box{width:min(900px,94vw); aspect-ratio:16/9; background:#000; border:1px solid rgba(255,255,255,.18); border-radius:14px; overflow:hidden; position:relative}
#ring3d .close{position:absolute; right:10px; top:10px}

#three3d{position:fixed; inset:0; pointer-events:none; z-index:-1;}
</style>
</head>

<body class="gated">

<!-- Local background song (starts on gate enter) -->
<audio id="bgSong" preload="auto" loop>
  <source src="assets/zara-sa.mp3" type="audio/mpeg">
</audio>

<!-- Entry fireworks canvas -->
<canvas id="fireEnter"></canvas>

<!-- Welcome Gate (always shown on load, inline-close so it NEVER breaks) -->

<div class="gate" id="gate" aria-modal="true" role="dialog">
  <div class="gate-card soft">
    <h1>Happy Birthday, Laadli Madamji üéÄüéÇ</h1>
    <p>Only pure and warm wishes for you today ü§åüèª‚ú®: Hope your smile stays constant while you read this.</p>
    <p class="muted">I‚Äôll stay in the background ‚Äî no demands, just your quiet cheer squad üëÄ.</p>

    <div class="gate-actions">

      <!-- ‚úÖ This inline IIFE hides and removes the gate, no other JS required -->
      <button
        class="btn" id="enterBtn" type="button"
        onclick="(function(){var g=document.getElementById('gate'); if(!g) return; g.classList.add('hide'); document.body.classList.remove('gated'); setTimeout(function(){ if(g&&g.parentNode) g.parentNode.removeChild(g); }, 450);}())">
        Enter the little night ‚Üí
      </button>

      <!-- Optional: play song via inline fallback, but does NOT block entering -->
      <button
        class="btn" id="playSongGate" type="button"
        onclick="(function(){try{ if(window.openYT){openYT();} else { var btn=document.getElementById('playSong'); btn&&btn.click(); } }catch(e){} }())">
        Play ‚ÄúZara Sa‚Äù üéµ
      </button>
    </div>

    <p class="hint">Ignore karo toh bhi theek hai ‚Äî I‚Äôm that silly boy who never stops trying ü´†.</p>
  </div>
</div>


<!-- place this immediately after the Gate markup -->
<script>
(function () {
  const url = new URL(location.href);
  if (url.searchParams.get('skip') === '1') {
    const g = document.getElementById('gate');
    if (g) {
      g.classList.add('hide');
      document.body.classList.remove('gated');
      setTimeout(()=> g.remove(), 10);
    }
    // honor the anchor (e.g., #spotlight) after the gate disappears
    if (location.hash) {
      setTimeout(() => {
        const target = document.querySelector(location.hash);
        target && target.scrollIntoView({behavior: 'smooth', block:'start'});
      }, 30);
    }
  }
})();
</script>

<!-- Top chrome -->
<div class="sig">made with <b>love</b> - by <b>Dev</b></div>
<div class="mood">
  <button class="n" title="Night"  onclick="setMood('night')"></button>
  <button class="g" title="Gulabi" onclick="setMood('gulabi')"></button>
  <button class="d" title="Denim"  onclick="setMood('denim')"></button>
  <button class="t3d" id="toggle3D" title="Toggle 3D">3D</button>
</div>

<!-- Sky layers -->
<canvas id="trail" aria-hidden="true"></canvas>
<canvas id="nameConstellation" aria-hidden="true"></canvas>
<div class="stars" aria-hidden="true"></div>
<canvas id="three3d" aria-hidden="true"></canvas>
<div id="petals" aria-hidden="true"></div>

<!-- 1) Landing -->
<section class="section" id="home">
  <div class="container center">
    <h1 class="title">On this small night, the universe plays its sweetest tune‚Ä¶</h1>
    <p class="lead muted">‚Ä¶because it‚Äôs your day, Shruti. (Madamji, Laadliji‚Äîhaan, dono tum ho.)</p>
    <div class="cta">
      <button class="btn" id="toggleSongBtn2">Wanna walk with me ? üéµ</button>
    </div>
  </div>
</section>

<!-- 2) Spark (diya + assurance) -->
<section class="section" id="spark">
  <div class="container center">
    <div class="diya soft" id="diya" title="Long-press me">
      <div class="bowl"></div><div class="oil"></div><div class="flame"></div><div class="glow"></div>
    </div>
    <p id="assureLine" class="muted" style="max-width:740px;margin:16px auto 6px">
      Aaj sirf duaayein: deadlines dayalu, playlist lambi, aur muskurahat asaan. Main yahin hoon‚Äîshanti se, bina demand ke‚Äîtumhari smile ka silly guard.
    </p>
    <div class="cta"><a class="btn" href="#blessings">Next ‚Üí</a></div>
  </div>
</section>

<!-- 3) Blessings -->
<section class="section" id="blessings">
  <div class="container" style="width:min(100%,960px)">
    <h2 class="center" style="margin-bottom:14px;color:var(--accent)">Cute Playful Blessings</h2>
    <div class="balloon-area" id="balloonArea" aria-label="Blessing balloons"></div>
    <p class="hint center">Tap a balloon to pop it.</p>
    <div class="center" style="margin-top:12px"><a class="btn" href="#cards">Next ‚Üí</a></div>
  </div>
  <div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="dialog">
      <h4 id="modalTitle">A note</h4>
      <p id="modalMsg">You are loved.</p>
      <button class="btn" id="modalClose">Close</button>
    </div>
  </div>
</section>

<!-- 4) Greeting Cards (flip) -->
<section class="section" id="cards">
  <div class="container center">
    <h2 style="margin:.2rem 0 .6rem;color:var(--accent)">Small Birthday Cards</h2>
    <p class="muted" style="margin-top:-6px">Tap to flip‚Äîchhoti si khushiyan aur meethi si shaitaani.</p>
    <div class="cards" id="cardsWrap"></div>
    <div class="cta" style="margin-top:14px"><a class="btn" href="#spotlight">Next ‚Üí</a></div>
  </div>
</section>

<!-- 5) Spotlight ‚Äî ONLY her photos -->
<section class="section" id="spotlight">
  <div class="container">
    <div class="gallery">
      <div class="hero soft">
        <img id="hero" alt="her photo" src="">
        <canvas id="stardust"></canvas>
      </div>
      <div class="polaroids" id="polaroids"></div>
      <div class="center" style="margin-top:8px">
        <button class="btn" id="openRing3D">Try 3D photo ring ‚ú®</button>
      </div>
      <p class="hint center">Every picture whispers: ‚Äúyou‚Äôre trouble, but the good kind, Madamji.‚Äù</p>
      <div class="center" style="margin-top:10px"><a class="btn" href="#lines">Next ‚Üí</a></div>
    </div>
  </div>
</section>

<!-- 6) Lines -->
<section class="section" id="lines">
  <div class="container">
    <div class="carousel">
      <div class="slide" id="slideText">No expectations. Bas good wishes, daily.</div>
      <div class="nav">
        <button class="btn" id="prevLine">‚Üê</button>
        <button class="btn" id="nextLine">‚Üí</button>
      </div>
    </div>
    <div class="center" style="margin-top:14px"><a class="btn" href="#divine">Next ‚Üí</a></div>
  </div>
</section>

<!-- 7) Divine blessing -->
<section class="section" id="divine">
  <div class="container center soft" style="padding:20px">
    <h2 style="margin:.4rem 0;color:var(--accent)">A small prayer</h2>
    <p class="muted" style="max-width:740px;margin:6px auto 0">
      May Kanhaji keep mischief in your smile and peace in your steps, and may Bajrangbali cover you with courage.
      May your days be soft where you need softness and strong where you need strength.
    </p>
    <div style="margin-top:12px"><a class="btn" href="#final">Final page ‚Üí</a></div>
  </div>
</section>

<!-- Finale -->
<section class="section final" id="final" style="overflow:hidden">
  <canvas id="fire" aria-hidden="true"></canvas>
  <div class="container center">
    <h2 style="margin:0 0 8px">Happy Birthday, <span id="herName">Madamji</span>!</h2>
    <p id="promiseLine">Is saal tumhare liye zyada sukoon, zyada hasi. Main sideline se quietly cheer karta rahunga‚Äîroz.</p>
    <div class="cta">
      <button class="btn" id="gift">Shower of cute things üéÅ</button>
      <button class="btn" id="savePNG">Save this promise (PNG)</button>
      <button class="btn" id="toggleSongBtn3">Pause / Play song üéµ</button>
    </div>
  </div>
</section>

<!-- Lightbox -->
<div class="lightbox" id="lb"><img id="lbImg" alt=""><button class="btn x" onclick="closeLB()">Close ‚úñ</button></div>

<!-- 3D Photo Ring overlay -->
<div id="ring3d">
  <div class="box">
    <canvas id="ringCanvas"></canvas>
    <button class="btn close" onclick="closeRing3D()">Close ‚úñ</button>
  </div>
</div>

<!-- Three.js (module) -->
<script type="module">
  import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
  window.THREE = THREE;
</script>

<script>
/* ---------- helpers ---------- */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const prefersReduced = matchMedia('(prefers-reduced-motion:reduce)').matches;

/* ---------- mood with memory ---------- */
function setMood(m){
  document.body.classList.remove('gulabi','denim');
  if(m==='gulabi') document.body.classList.add('gulabi');
  if(m==='denim')  document.body.classList.add('denim');
  localStorage.setItem('mood',m);
}
(function initMood(){ setMood(localStorage.getItem('mood')||'night'); })();

/* ---------- petals ---------- */
(function petals(){
  const wrap = $('#petals');
  for(let i=0;i<(prefersReduced?8:22);i++){
    const p=document.createElement('div'); p.className='petal';
    p.style.left=(Math.random()*100)+'vw';
    const dur=11000+Math.random()*9000, delay=Math.random()*4000, drift=(Math.random()<.5?-1:1)*(8+Math.random()*10);
    p.animate([{transform:'translate(0,0) rotate(0deg)',top:'-40px'},
               {transform:`translate(${drift}vw,110vh) rotate(${Math.random()*360}deg)`,top:'110vh'}],
              {duration:dur,delay,iterations:Infinity,easing:'ease-in'});
    wrap.appendChild(p);
  }
})();

/* ---------- star trail + full-name constellation ---------- */
(function starTrail(){
  const c=$('#trail'), ctx=c.getContext('2d'); let W,H; const parts=[];
  function fit(){ W=c.width=innerWidth; H=c.height=innerHeight } fit(); addEventListener('resize',fit);
  function spawn(x,y){ parts.push({x,y,vx:(Math.random()-0.5)*1.2,vy:(Math.random()-0.5)*1.2,life:40}); }
  function draw(){ ctx.clearRect(0,0,W,H); for(let i=parts.length-1;i>=0;i--){ const p=parts[i]; p.x+=p.vx; p.y+=p.vy; p.life--; ctx.fillStyle=`rgba(255,210,230,${p.life/40})`; ctx.fillRect(p.x,p.y,2,2); if(p.life<=0) parts.splice(i,1); } requestAnimationFrame(draw) } draw();
  let timer=null;
  function touch(e){ const t=e.touches?e.touches[0]:e; spawn(t.clientX,t.clientY); if(timer) clearTimeout(timer); timer=setTimeout(()=> nameConstellation($('#herName').textContent||'Shruti'), 1400); }
  addEventListener('mousemove',touch); addEventListener('touchmove',touch,{passive:true});
})();
function nameConstellation(name){
  const cvs=$('#nameConstellation'), ctx=cvs.getContext('2d'); cvs.width=innerWidth; cvs.height=innerHeight;
  let pts=[]; const fam='Poppins, ui-sans-serif, system-ui';
  function lines(text){ const t=(text||'You').trim().replace(/\s+/g,' '); if(t.length<=14) return [t]; const mid=Math.floor(t.length/2); let s=t.lastIndexOf(' ',mid); if(s<6||t.length-s<6) s=t.indexOf(' ',mid); return s>0?[t.slice(0,s),t.slice(s+1)]:[t]; }
  function targets(ls,density=22){
    const off=document.createElement('canvas'), o=off.getContext('2d'); off.width=cvs.width; off.height=cvs.height;
    let fs=Math.min(200,Math.max(70,off.width*0.16)); const maxW=off.width*.84;
    function w(t){o.font=`800 ${fs}px ${fam}`;return o.measureText(t).width} while(Math.max(...ls.map(w))>maxW&&fs>36) fs-=2;
    o.textAlign='center'; o.textBaseline='middle'; o.fillStyle='#fff'; o.font=`800 ${fs}px ${fam}`;
    const midY=off.height*.42, gap=fs*1.2; ls.forEach((t,i)=>o.fillText(t,off.width/2,midY+(i-(ls.length-1)/2)*gap));
    const data=o.getImageData(0,0,off.width,off.height).data, arr=[], step=Math.max(1,Math.floor(fs/density));
    for(let y=0;y<off.height;y+=step) for(let x=0;x<off.width;x+=step) if(data[(y*off.width+x)*4+3]>128) arr.push({x,y});
    return arr;
  }
  const cloud = targets(lines(name)); const N=Math.min(520,Math.max(200,Math.floor(cloud.length*.55)));
  for(let i=0;i<N;i++){ const t=cloud[Math.floor(i*(cloud.length/N))]||{x:Math.random()*cvs.width,y:Math.random()*cvs.height};
    pts.push({x:Math.random()*cvs.width,y:Math.random()*cvs.height*0.8+cvs.height*0.1, tx:t.x, ty:t.y}); }
  let phase='in', t0=performance.now();
  (function frame(t){
    ctx.clearRect(0,0,cvs.width,cvs.height);
    for(const p of pts){ p.x+=(p.tx-p.x)*0.08; p.y+=(p.ty-p.y)*0.08; ctx.fillStyle='rgba(255,210,230,.95)'; ctx.fillRect(p.x,p.y,2,2); }
    if(phase==='in' && t-t0>3800){ phase='out'; pts.forEach(p=>{ p.tx=Math.random()*cvs.width; p.ty=Math.random()*cvs.height*0.8+cvs.height*0.1; }); }
    if(phase==='out' && !pts.some(p=>Math.hypot(p.tx-p.x,p.ty-p.y)>0.6)) { ctx.clearRect(0,0,cvs.width,cvs.height); return; }
    requestAnimationFrame(frame);
  })(t0);
}

/* ---------- diya + typed assurance + long-press note ---------- */
const sparkIO=new IntersectionObserver(es=>{ es.forEach(e=>{ if(e.isIntersecting){ $('#diya').classList.add('lit'); typeAssure(); } }); },{threshold:.45});
sparkIO.observe($('#spark'));
function typeAssure(){ const el=$('#assureLine'); const t=el.textContent.trim(); el.textContent=''; let i=0; const id=setInterval(()=>{ el.textContent+=t.charAt(i++); if(i>=t.length) clearInterval(id); },26); }
(function longPress(){
  const el=$('#diya'); let timer=null;
  const open=()=>showModal('A small note','Space chahiye toh milegi. Main bas background me diya jala ke rakhoonga.');
  el.addEventListener('pointerdown',()=>{ timer=setTimeout(open,650); });
  ['pointerup','pointerleave','pointercancel'].forEach(ev=> el.addEventListener(ev,()=>clearTimeout(timer)));
})();

/* ---------- blessings balloons (aligned columns, slower, no overlap) ---------- */
const blessings=[
  {word:'Sukoon',  color:'#ff9ccc', msg:'Har din ka pressure halka ho, aur raatein araam se kathein.'},
  {word:'Himmat',  color:'#9bd3ff', msg:'Jab bhi tough lage, kehna‚Äîmain cheer squad hoon.'},
  {word:'Vishwas', color:'#c9a7ff', msg:'Vaade nahi‚Äîroz ki imandari. Bas itna.'},
  {word:'Khushi',  color:'#7ee6c9', msg:'Chhoti jeetain, badi badi hansi.'},
  {word:'Sehat',   color:'#ffd86e', msg:'Neend gehri, sehat mazboot, aura bright.'},
  {word:'Barkat',  color:'#ffb6a3', msg:'Laadliji, Ramji ki kripa aur ghar me barkat.'},
];
let balloonsInit=false;
function spawnBalloons(){
  if(balloonsInit) return; balloonsInit=true;
  const area=$('#balloonArea');
  const cols=[8,24,40,56,72,88]; // fixed columns to prevent overlap
  blessings.forEach((b,i)=>{
    const d=document.createElement('button'); d.className='balloon';
    d.style.setProperty('--c',b.color);
    d.style.setProperty('--x', cols[i % cols.length]);
    d.style.setProperty('--delay', i*3); // staggered
    d.innerHTML=`<span>${b.word}</span>`;
    d.addEventListener('click',()=>{ popBlessing(d,b); });
    area.appendChild(d);
  });
}
function popBlessing(el,b){
  try{ navigator.vibrate && navigator.vibrate(12);}catch{}
  el.animate([{transform:'scale(1)'},{transform:'scale(1.2)'},{transform:'scale(0)'}],{duration:260,easing:'ease-in'});
  setTimeout(()=>el.remove(),220);
  playChime(); showModal(b.word,b.msg);
}
function showModal(title,msg){ $('#modalTitle').textContent=title; $('#modalMsg').textContent=msg; $('#modal').classList.add('show'); }
$('#modal').addEventListener('click',(e)=>{ if(e.target.id==='modal'||e.target.id==='modalClose') $('#modal').classList.remove('show'); });
const blessIO=new IntersectionObserver(es=>{ es.forEach(e=>{ if(e.isIntersecting) spawnBalloons(); }); },{threshold:.4});
blessIO.observe($('#blessings'));

/* ---------- greeting cards (flip) ---------- */
const greetingCards=[
 {title:'Nazar Na Lage', 'üßø', text:'Madamji, nazar buri lage bhi toh‚Äîtum par Kanhaji ki chhaya aur meri rakhwali humesha rahegi.'},
 {title:'Chai + Calm',  '‚òïÔ∏è', text:'Subah ki chai ya raat ka sukoon‚Äîjo chahiye, bol do. Main dhoondh launga.'},
 {title:'Calendar Bless', 'üìÖ', text:'Is saal ka har Monday halka, aur har Friday ke beech me thodi si chhutti mile aapko.'},
 {title:'Inbox of Joy',  'üì´', text:'Roz thoda sa pyaar aur thodi hansi (spam free and ad free).'},
];
(function buildCards(){
  const wrap=$('#cardsWrap');
  greetingCards.forEach((c)=>{
    const card=document.createElement('article'); card.className='flip-card';
    card.innerHTML=`
      <div class="flip-inner">
        <div class="face front">
          <h3>${c.title}</h3>
          <p class="muted">Tap to open</p>
          <div class="openHint">Charm: ${c.charm}</div>
        </div>
        <div class="face back">
          <p>${c.text}</p>
          <div class="openHint">Tap to close</div>
        </div>
      </div>`;
    card.addEventListener('click',()=>{ card.classList.toggle('open'); playChime(); });
    wrap.appendChild(card);
  });
})();

/* ---------- spotlight photos (replace later) ---------- */
const PHOTOS = [
  // later: {src:'images/shruti-01.jpg'},
];
(function gallery(){
  const hero=$('#hero'), grid=$('#polaroids');
  if(PHOTOS.length===0){
    hero.src='https://images.unsplash.com/photo-1529626455594-4ff0802cfb7e?w=1600&q=80&auto=format&fit=crop';
    grid.innerHTML='<div class="muted" style="grid-column:1/-1;text-align:center">Add her photos in <code>PHOTOS</code> later.</div>';
  } else {
    let cur=0; hero.src=PHOTOS[0].src;
    PHOTOS.forEach((p,i)=>{
      const d=document.createElement('div'); d.className='pol'; d.style.setProperty('--r', (Math.random()*6-3)+'deg');
      d.innerHTML=`<img src="${p.src}" alt="her ${i+1}">`;
      d.addEventListener('click',()=>{ cur=i; hero.src=p.src; $$('.pol').forEach(x=>x.classList.remove('active')); d.classList.add('active'); });
      let dragging=false,sx=0,sy=0; d.addEventListener('pointerdown',e=>{ dragging=true; d.setPointerCapture(e.pointerId); sx=e.clientX; sy=e.clientY; d.style.transition='none'; });
      d.addEventListener('pointermove',e=>{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; d.style.transform=`translate(${dx}px,${dy}px) rotate(var(--r))`; });
      d.addEventListener('pointerup',()=>{ dragging=false; d.style.transition='transform .2s'; d.style.transform='rotate(var(--r))'; });
      d.addEventListener('dblclick',()=>openLB(p.src));
      grid.appendChild(d);
    });
    hero.addEventListener('click',()=>openLB(PHOTOS[cur]?.src||hero.src));
  }
  // Stardust over hero
  initStardust('images/SHRUTI_STARDUST.jpg'); // <<< replace with your image path later
})();
function openLB(src){ $('#lbImg').src=src; $('#lb').style.display='flex'; }
function closeLB(){ $('#lb').style.display='none'; }

/* ---------- stardust reveal (clearer image) ---------- */
function initStardust(src){
  const cvs = $('#stardust'); if(!cvs) return;
  const hero = cvs.parentElement;
  function size(){ cvs.width = hero.clientWidth; cvs.height = hero.clientHeight; }
  size(); addEventListener('resize', size);

  const ctx = cvs.getContext('2d');
  const img = new Image(); img.src = src; img.crossOrigin = 'anonymous';
  img.onload = () => {
    // draw faint base image for clarity
    const scale = Math.min(cvs.width/img.width, cvs.height/img.height);
    const w = img.width*scale, h = img.height*scale;
    const x = (cvs.width - w)/2, y = (cvs.height - h)/2;

    // sample points
    const off = document.createElement('canvas'); off.width = w; off.height = h; const octx = off.getContext('2d');
    octx.drawImage(img, 0, 0, w, h);
    const data = octx.getImageData(0,0,w,h).data;

    const pts=[];
    const step = Math.max(2, Math.floor(w/240)); // density
    for(let yy=0; yy<h; yy+=step){
      for(let xx=0; xx<w; xx+=step){
        const i = ((yy|0)*w + (xx|0))*4;
        const a = data[i+3];
        if(a>130){ // visible
          pts.push({
            x: Math.random()*cvs.width, y: Math.random()*cvs.height,
            tx: x+xx, ty: y+yy,
            life: 0
          });
        }
      }
    }

    let t0=null;
    function frame(t){
      if(!t0) t0=t;
      const k = Math.min(1,(t-t0)/1600); // ease-in
      ctx.clearRect(0,0,cvs.width,cvs.height);

      // base faint image
      ctx.globalAlpha = 0.18;
      ctx.drawImage(img, x, y, w, h);
      ctx.globalAlpha = 1;

      for(const p of pts){
        p.x += (p.tx-p.x)*0.08;
        p.y += (p.ty-p.y)*0.08;
        // soft glow
        ctx.fillStyle = 'rgba(255,220,240,.9)';
        ctx.fillRect(p.x, p.y, 2, 2);
      }
      if(k<1) requestAnimationFrame(frame);
      else shimmer();
    }
    requestAnimationFrame(frame);

    function shimmer(){
      // gentle micro-move
      let t=0;
      (function loop(){
        ctx.clearRect(0,0,cvs.width,cvs.height);
        ctx.globalAlpha = 0.18;
        ctx.drawImage(img, x, y, w, h);
        ctx.globalAlpha = 1;

        for(const p of pts){
          const nx = Math.sin((p.tx+p.ty+t)*0.002)*0.6;
          const ny = Math.cos((p.tx-p.ty-t)*0.002)*0.6;
          ctx.fillStyle = 'rgba(255,210,230,.95)';
          ctx.fillRect(p.tx+nx, p.ty+ny, 2, 2);
        }
        t+=1.2;
        requestAnimationFrame(loop);
      })();
    }
  };
}

/* ---------- inside lines ---------- */
const LINES=[
  'No expectations. just pure good wishes, daily.',
  'Ignore mode on? Theek hai, main yahin, quietly rooting.',
  'Main impress karna nahi, consistent rehna chahta hoon, hope you get it!.',
  'Madamji, tum muskurao ‚Äî baaki sab adjust ho jayega.',
  '1% chance bhi agar hoga? Main 100% mehnat karta rahunga - without complaining.',
];
let li=0; const slide=$('#slideText');
$('#nextLine').addEventListener('click',()=>{ li=(li+1)%LINES.length; slide.innerText=LINES[li]; playChime(); });
$('#prevLine').addEventListener('click',()=>{ li=(li-1+LINES.length)%LINES.length; slide.innerText=LINES[li]; playChime(); });

/* ---------- fireworks (final + entry burst) ---------- */
function fireworksOnCanvas(cId, duration=12000, quick=false){
  const c=$(cId), a=c.getContext('2d'); function fit(){ c.width=innerWidth; c.height=innerHeight } fit(); addEventListener('resize',fit);
  const ps=[]; function add(x,y,vx,vy,col){ ps.push({x,y,vx,vy,col,life:70+Math.random()*30}) }
  function hv(t){ const x=16*Math.sin(t)**3, y=13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t); return {x, y:-y}; }
  function burst(x,y,col,heart=true){ const n=heart?140:90; for(let i=0;i<n;i++){ if(heart){ const t=i/n*Math.PI*2, v=hv(t), m=Math.hypot(v.x,v.y)||1, s=2.2+Math.random()*2.4; add(x,y,(v.x/m)*s,(v.y/m)*s,col); } else { const ang=Math.PI*2*i/n, s=2+Math.random()*3; add(x,y,Math.cos(ang)*s,Math.sin(ang)*s,col); } } }
  function tick(){ a.clearRect(0,0,c.width,c.height); for(let i=ps.length-1;i>=0;i--){ const p=ps[i]; p.x+=p.vx; p.y+=p.vy; p.vy+=0.03; p.life--; a.fillStyle=`rgba(${p.col},${Math.max(0,p.life/100)})`; a.fillRect(p.x,p.y,2,2); if(p.life<=0) ps.splice(i,1); } req=requestAnimationFrame(tick) } let req; tick();
  function boom(){ const x=Math.random()*c.width*.9+c.width*.05, y=Math.random()*c.height*.4+c.height*.1; const cols=['255,200,221','255,168,194','201,167,255','246,208,110']; burst(x,y,cols[Math.floor(Math.random()*cols.length)],Math.random()<.7); }
  if(quick){ for(let i=0;i<4;i++) setTimeout(boom,i*300); }
  const iv=setInterval(boom,1300); setTimeout(()=>{ clearInterval(iv); cancelAnimationFrame(req); a.clearRect(0,0,c.width,c.height); }, duration);
}
let fwStarted=false;
const fwIO=new IntersectionObserver(es=>{ es.forEach(e=>{ if(e.isIntersecting && !fwStarted){ fwStarted=true; fireworksOnCanvas('#fire'); } }); },{threshold:.42});
fwIO.observe($('#final'));

/* ---------- gift rain ---------- */
$('#gift').addEventListener('click',()=>{ try{navigator.vibrate&&navigator.vibrate(14);}catch{} const icons=['üß∏','üç´','üíó','üíû','‚ú®','üå∏','üç¨','ü™î','üßø','üåº'];
  const D=5200,t0=performance.now(); (function drop(){ if(performance.now()-t0>D) return; const s=document.createElement('span'); s.textContent=icons[Math.floor(Math.random()*icons.length)];
    s.style.position='fixed'; s.style.top='-40px'; s.style.left=(Math.random()*innerWidth)+'px'; s.style.fontSize='32px'; s.style.zIndex='60'; document.body.appendChild(s);
    const drift=(Math.random()*2-1)*80,time=2400+Math.random()*1800; s.animate([{transform:'translate(0,-40px)',opacity:.95},{transform:`translate(${drift}px, ${innerHeight+60}px)`,opacity:.1}],{duration:time,easing:'ease-in'});
    setTimeout(()=>s.remove(),time+60); requestAnimationFrame(drop) })();
});

/* ---------- save final promise as PNG ---------- */
$('#savePNG').addEventListener('click',()=>{
  const name=$('#herName').textContent||'You'; const text=$('#promiseLine').textContent||'With love.';
  const w=1200,h=630, cn=document.createElement('canvas'); cn.width=w; cn.height=h; const ctx=cn.getContext('2d');
  const grad=ctx.createLinearGradient(0,0,0,h); grad.addColorStop(0,'#0c1022'); grad.addColorStop(1,'#14102e'); ctx.fillStyle=grad; ctx.fillRect(0,0,w,h);
  ctx.fillStyle='rgba(255,255,255,.08)'; for(let i=0;i<200;i++){ ctx.fillRect(Math.random()*w,Math.random()*h,2,2); }
  ctx.fillStyle='#ff9ccc'; ctx.font='700 44px "Playfair Display", serif'; ctx.textAlign='center'; ctx.fillText('Happy Birthday, '+name, w/2, h/2-20);
  ctx.fillStyle='#e8edff'; ctx.font='400 28px Poppins, sans-serif'; wrapText(ctx, text, w/2, h/2+28, 900, 36);
  const a=document.createElement('a'); a.href=cn.toDataURL('image/png'); a.download=`Promise-${name}.png`; a.click();
});
function wrapText(ctx, text, x, y, maxWidth, lineHeight){
  const words=text.split(' '); let line=''; for(let n=0;n<words.length;n++){ const test=line+words[n]+' '; const w=ctx.measureText(test).width;
    if(w>maxWidth && n>0){ ctx.fillText(line, x, y); line=words[n]+' '; y+=lineHeight; } else { line=test; } }
  ctx.fillText(line, x, y);
}

/* ---------- ambience (tiny chimes) ---------- */
let ac, master;
function ensureAudioCtx(){ if(ac) return; ac=new (window.AudioContext||window.webkitAudioContext)(); master=ac.createGain(); master.gain.value=0.0; master.connect(ac.destination); }
function startAmbience(){
  try{
    ensureAudioCtx(); ac.resume&&ac.resume();
    const g=ac.createGain(); g.gain.value=0.0; g.connect(master);
    function flute(freq, t0, dur){
      const o=ac.createOscillator(); o.type='sine'; o.frequency.value=freq;
      const v=ac.createOscillator(); v.frequency.value=5; const vGain=ac.createGain(); vGain.gain.value=2; v.connect(vGain); vGain.connect(o.frequency);
      const eg=ac.createGain(); eg.gain.setValueAtTime(0.0001,t0); eg.gain.linearRampToValueAtTime(0.10,t0+.4); eg.gain.linearRampToValueAtTime(0.05,t0+.8); eg.gain.exponentialRampToValueAtTime(0.0001,t0+dur);
      o.connect(eg); eg.connect(g); o.start(t0); v.start(t0); o.stop(t0+dur+.05); v.stop(t0+dur+.05);
    }
    function bell(t){
      [1,2.01,2.98,4.2].forEach((m,i)=>{ const o=ac.createOscillator(); o.frequency.value=660*m; const eg=ac.createGain(); eg.gain.setValueAtTime(0.0001,t);
        eg.gain.exponentialRampToValueAtTime(0.06/(i+1),t+.02); eg.gain.exponentialRampToValueAtTime(0.0001,t+1.2+i*0.2); o.connect(eg); eg.connect(g); o.start(t); o.stop(t+1.6+i*0.2); });
    }
    const start=ac.currentTime+.1; const phrase=t=>{[440,494,523,587,523,494,440].forEach((f,i)=>flute(f/2,t+i*.9,1.2)); bell(t+2.7);};
    phrase(start); setInterval(()=>phrase(ac.currentTime+.1),5000);
    master.gain.cancelScheduledValues(ac.currentTime); master.gain.linearRampToValueAtTime(0.08, ac.currentTime+1.2);
    g.gain.linearRampToValueAtTime(0.08, ac.currentTime+1.2);
  }catch{}
}
function playChime(){ try{ ensureAudioCtx(); const o=ac.createOscillator(), g=ac.createGain(); o.type='sine'; o.frequency.value=880; g.gain.value=0.0001; o.connect(g); g.connect(master);
  const t=ac.currentTime; g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(0.1,t+0.02); g.gain.exponentialRampToValueAtTime(0.0001,t+0.4); o.start(t); o.stop(t+0.42);}catch{} }

/* ---------- Local MP3 controls ---------- */
function playBgSongFadeIn(){
  const a = $('#bgSong'); if(!a) return Promise.resolve();
  a.muted=false; a.volume=0;
  const p=a.play(); if(!p||typeof p.then!=='function') return Promise.resolve();
  return p.then(()=>{
    let v=0, target=0.85, step=0.02;
    const id=setInterval(()=>{ v+=step; a.volume=Math.min(target,v); if(v>=target) clearInterval(id); },80);
  }).catch(()=>Promise.resolve());
}
function pauseBgSongFadeOut(){
  const a=$('#bgSong'); if(!a) return;
  let v=a.volume, step=0.04; const id=setInterval(()=>{ v-=step; a.volume=Math.max(0,v); if(v<=0){ clearInterval(id); a.pause(); } },60);
}
function toggleSong(){
  const a=$('#bgSong'); if(!a) return;
  if(a.paused) playBgSongFadeIn(); else pauseBgSongFadeOut();
}
$('#toggleSongBtn').addEventListener('click', toggleSong);
$('#toggleSongBtn2').addEventListener('click', toggleSong);
$('#toggleSongBtn3').addEventListener('click', toggleSong);

/* ---------- Welcome Gate ---------- */
function hideGate(){
  const gate=document.getElementById('gate'); if(!gate) return;
  gate.classList.add('hide'); document.body.classList.remove('gated');
  setTimeout(()=>gate.remove(),500);
  try{ document.getElementById('home')?.scrollIntoView({behavior:'smooth'}); }catch{}
}
async function enterGate(){
  // start MP3 + small entry fireworks
  await playBgSongFadeIn();
  startAmbience();
  const fe = $('#fireEnter'); fe.style.opacity='1'; fireworksOnCanvas('#fireEnter', 5000, true); // quick burst
  setTimeout(()=>{ fe.style.opacity='0'; }, 5200);
  hideGate();
}
window.enterGate = enterGate;
document.addEventListener('click', (e)=>{ const btn = e.target.closest('#enterBtn'); if(btn && document.getElementById('gate')) enterGate(); });
document.addEventListener('keydown',e=>{ if(document.getElementById('gate') && (e.key==='Enter'||e.key===' ')) enterGate(); });

/* ===================== 3D MODE (beefed up) ===================== */
(() => {
  if(!window.THREE) return;
  const btn = document.getElementById('toggle3D');
  const canvas = document.getElementById('three3d');
  let renderer, scene, camera, stars, rafId, hearts = [], clock, extras=[];

  function init3D(){
    if(renderer) return;
    renderer = new THREE.WebGLRenderer({ canvas, alpha:true, antialias:true });
    renderer.setPixelRatio(Math.min(2, window.devicePixelRatio||1));
    resize();
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 1000);
    camera.position.set(0,0,28);
    clock = new THREE.Clock();

    // star points
    const starGeo = new THREE.BufferGeometry();
    const N = 1400;
    const pos = new Float32Array(N*3);
    for(let i=0;i<N;i++){
      pos[i*3+0] = (Math.random()-0.5)*200;
      pos[i*3+1] = (Math.random()-0.5)*140;
      pos[i*3+2] = (Math.random()-0.5)*200;
    }
    starGeo.setAttribute('position', new THREE.BufferAttribute(pos,3));
    const starMat = new THREE.PointsMaterial({ size:1.3, color: new THREE.Color('#ffd2ea'), transparent:true, opacity:0.9 });
    stars = new THREE.Points(starGeo, starMat);
    scene.add(stars);

    // creative extras: slow torus knots + sparkle sprites
    const knotMat = new THREE.MeshBasicMaterial({ color:0xffb3d7, wireframe:true, transparent:true, opacity:0.22 });
    for(let i=0;i<3;i++){
      const g = new THREE.TorusKnotGeometry(2.2+i*0.5, 0.5, 120, 18);
      const m = new THREE.Mesh(g, knotMat.clone());
      m.position.set((i-1)*4, (i%2?-2:2), -4-i*2);
      scene.add(m); extras.push(m);
    }
    const sparkleGeo = new THREE.BufferGeometry();
    const S = 400; const spos = new Float32Array(S*3);
    for(let i=0;i<S;i++){ spos[i*3]=(Math.random()-0.5)*30; spos[i*3+1]=(Math.random()-0.5)*20; spos[i*3+2]=(Math.random()-0.5)*30; }
    sparkleGeo.setAttribute('position', new THREE.BufferAttribute(spos,3));
    const sparkle = new THREE.Points(sparkleGeo, new THREE.PointsMaterial({ size:0.6, color:0xffffff, transparent:true, opacity:0.8 }));
    scene.add(sparkle); extras.push(sparkle);

    const fog = new THREE.FogExp2(0x0e1022, 0.006); scene.fog = fog;

    let mx=0,my=0;
    window.addEventListener('mousemove', e=>{ mx=(e.clientX/innerWidth - .5)*2; my=(e.clientY/innerHeight - .5)*2; });

    const animate = () => {
      const t = clock.getElapsedTime();
      stars.rotation.y = t*0.02;
      extras.forEach((m,i)=>{ m.rotation.x += 0.002*(i+1); m.rotation.y += 0.003*(i+1); });
      camera.position.x += (mx*4 - camera.position.x)*0.02;
      camera.position.y += (-my*2 - camera.position.y)*0.02;

      for(let i=hearts.length-1;i>=0;i--){
        const p = hearts[i];
        p.v.add(p.g); p.m.position.add(p.v); p.life--;
        p.m.material.opacity = Math.max(0, p.life/120);
        if(p.life<=0){ scene.remove(p.m); p.m.geometry.dispose(); p.m.material.dispose(); hearts.splice(i,1); }
      }
      renderer.render(scene,camera);
      rafId = requestAnimationFrame(animate);
    };
    animate();
    window.addEventListener('resize', resize);
  }

  function resize(){
    if(!renderer) return;
    renderer.setSize(innerWidth, innerHeight, false);
    if(camera){ camera.aspect = innerWidth/innerHeight; camera.updateProjectionMatrix(); }
  }

  function burstHearts(col='#ff8fb1'){
    if(!renderer) return;
    const count = 120;
    for(let i=0;i<count;i++){
      const geo = new THREE.PlaneGeometry(0.8,0.8);
      const mat = new THREE.MeshBasicMaterial({ color: new THREE.Color(col), transparent:true, opacity:1, side:THREE.DoubleSide });
      const m = new THREE.Mesh(geo, mat);
      const t = (i/count)*Math.PI*2;
      const x = 1.6*Math.pow(Math.sin(t),3);
      const y = 1.3*Math.cos(t) - 0.5*Math.cos(2*t) - 0.2*Math.cos(3*t) - 0.1*Math.cos(4*t);
      m.position.set(x*4, y*4, (Math.random()-0.5)*4);
      scene.add(m);
      const v = new THREE.Vector3(x, y, (Math.random()-0.5)).normalize().multiplyScalar(0.08 + Math.random()*0.14);
      hearts.push({ m, v, g:new THREE.Vector3(0,-0.001,0), life: 120+Math.random()*30 });
    }
  }

  document.getElementById('gift')?.addEventListener('click', ()=> burstHearts('#ffd86e'));

  function enable3D(){
    if(prefersReduced){ alert('3D mode respects reduced-motion and is off.'); return; }
    btn.classList.add('active'); localStorage.setItem('threeEnabled','1');
    init3D(); burstHearts(); setTimeout(()=>burstHearts('#c9a7ff'), 2200);
  }
  function disable3D(){
    btn.classList.remove('active'); localStorage.removeItem('threeEnabled');
    if(rafId) cancelAnimationFrame(rafId);
    if(renderer){
      renderer.dispose(); renderer.forceContextLoss && renderer.forceContextLoss();
      window.removeEventListener('resize', resize);
    }
    if(scene){
      scene.traverse(o=>{
        if(o.geometry) o.geometry.dispose?.();
        if(o.material){ if(Array.isArray(o.material)) o.material.forEach(m=>m.dispose?.()); else o.material.dispose?.(); }
      });
    }
    renderer=scene=camera=stars=clock=null; hearts=[]; extras=[];
    const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl'); gl && gl.getExtension('WEBGL_lose_context')?.loseContext();
  }

  btn.addEventListener('click', ()=> (renderer ? disable3D() : enable3D()));
  if(localStorage.getItem('threeEnabled')==='1' && !prefersReduced) enable3D();
})();

/* ===================== 3D PHOTO RING (overlay) ===================== */
(() => {
  if(!window.THREE) return;
  const overlay = document.getElementById('ring3d');
  const canvas  = document.getElementById('ringCanvas');
  const btnOpen = document.getElementById('openRing3D');

  let renderer, scene, camera, ringGroup, rafId, dragging=false, lastX=0;

  function openRing3D(){
    if(!Array.isArray(PHOTOS) || PHOTOS.length===0){
      alert('Add her photos in the PHOTOS array to use the 3D ring.'); return;
    }
    overlay.style.display='flex';
    initRing();
  }
  function closeRing3D(){
    overlay.style.display='none';
    if(rafId) cancelAnimationFrame(rafId);
    if(renderer){ renderer.dispose(); renderer.forceContextLoss && renderer.forceContextLoss(); }
    if(scene){
      scene.traverse(o=>{
        if(o.geometry) o.geometry.dispose?.();
        if(o.material){ if(Array.isArray(o.material)) o.material.forEach(m=>m.dispose?.()); else o.material.dispose?.(); }
        if(o.texture) o.texture.dispose?.();
      });
    }
    renderer=scene=camera=ringGroup=null;
  }
  window.closeRing3D = closeRing3D;

  function initRing(){
    renderer = new THREE.WebGLRenderer({ canvas, antialias:true });
    renderer.setPixelRatio(Math.min(2, window.devicePixelRatio||1));
    size();
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(55, canvas.clientWidth/canvas.clientHeight, 0.1, 1000);
    camera.position.set(0,0,18);

    const amb = new THREE.AmbientLight(0xffffff, 0.9); scene.add(amb);

    ringGroup = new THREE.Group(); scene.add(ringGroup);
    const loader = new THREE.TextureLoader(); loader.crossOrigin = 'anonymous';
    const R = 10, n = Math.min(12, PHOTOS.length);
    for(let i=0;i<n;i++){
      const tex = loader.load(PHOTOS[i].src);
      tex.minFilter = THREE.LinearFilter;
      const mat = new THREE.MeshBasicMaterial({ map: tex, side: THREE.DoubleSide });
      const geo = new THREE.PlaneGeometry(6, 9);
      const mesh = new THREE.Mesh(geo, mat);
      const a = (i/n)*Math.PI*2;
      mesh.position.set(Math.cos(a)*R, 0, Math.sin(a)*R);
      mesh.lookAt(0,0,0);
      ringGroup.add(mesh);
    }

    canvas.addEventListener('pointerdown', e=>{ dragging=true; lastX=e.clientX; });
    canvas.addEventListener('pointermove', e=>{
      if(!dragging) return;
      const dx = (e.clientX - lastX); lastX = e.clientX; ringGroup.rotation.y += dx * 0.005;
    });
    window.addEventListener('pointerup', ()=> dragging=false);

    const animate = ()=>{
      if(!dragging) ringGroup.rotation.y += 0.004;
      renderer.render(scene, camera);
      rafId = requestAnimationFrame(animate);
    };
    animate();
    window.addEventListener('resize', size);
  }

  function size(){
    const w = overlay.clientWidth || innerWidth;
    const h = overlay.clientHeight || innerHeight;
    renderer?.setSize(w*0.94, h*0.82, false);
    camera && (camera.aspect = (w*0.94)/(h*0.82), camera.updateProjectionMatrix());
  }

  btnOpen?.addEventListener('click', openRing3D);
})();
</script>
</body>
</html>


