<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>for Shruti ‚Äî a small night</title>
<meta name="description" content="A birthday page for Shruti‚Äîblessings, silly-boy-trying energy, her photos, 3D stardust and heart fireworks‚Äîwith quiet spiritual vibes.">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@700;800&family=Quicksand:wght@400;600;700&family=Caveat:wght@600&family=Satisfy&display=swap" rel="stylesheet">

<style>
/* ---------- THEME TOKENS ---------- */
:root{
  --bg1:#0c1022; --bg2:#14102e; --ink:#eef2ff; --muted:#cdd5f9; --accent:#ff8fb1; --edge:rgba(255,255,255,.12);
  --petal:#ffc8dd; --gold:#f6d06e; --card:#10182a; --card2:#0f1730;
}
body.gulabi{ --bg1:#1a0b24; --bg2:#2a1345; --accent:#ff96c8; --ink:#fff4fa; --muted:#ffd9e8; --petal:#ffd1e1; --card:#1a1430; --card2:#23193f }
body.denim { --bg1:#0b1322; --bg2:#0b1b33; --accent:#85a9ff; --ink:#eaf2ff; --muted:#cfe0ff; --petal:#c7d7ff; --card:#0c1629; --card2:#0e1d36 }
body.spring{ --bg1:#fff9fb; --bg2:#f3ffe8; --accent:#52d6a0; --ink:#1b2230; --muted:#4b5a79; --petal:#ffe0ec; --card:#ffffffdd; --card2:#f6fff1 }
body.dusk  { --bg1:#131022; --bg2:#0b1020; --accent:#bca2ff; --ink:#e9e7ff; --muted:#c9c6ff; --petal:#d7c9ff; --card:#141726; --card2:#0f1424 }

html,body{height:100%} html{scroll-behavior:smooth}
@media (prefers-reduced-motion:reduce){
  *{animation-duration:.001ms!important;animation-iteration-count:1!important;transition-duration:.001ms!important;scroll-behavior:auto!important}
}
body{
  margin:0; color:var(--ink);
  font-family:Quicksand,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  background:
   radial-gradient(900px 440px at 50% -12%, rgba(155,211,255,.14), transparent 60%),
   linear-gradient(180deg,var(--bg1),var(--bg2));
  overflow-x:hidden;
}
h1,h2{font-family:"Fraunces",serif}
.container{max-width:980px;margin:0 auto;padding:0 16px}
.section{min-height:100vh;display:grid;place-items:center;padding:84px 0;position:relative}
.center{text-align:center}
.muted{color:var(--muted)}
a.btn,button.btn{appearance:none;border:0;border-radius:16px;padding:12px 18px;font-weight:800;cursor:pointer;color:#0c0f17;
  background:linear-gradient(90deg,var(--accent),#c9a7ff);box-shadow:0 12px 24px rgba(0,0,0,.28)}
.btn:active{transform:translateY(1px) scale(.99)}
.soft{border:1px solid var(--edge);border-radius:18px;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));box-shadow:0 18px 44px rgba(0,0,0,.35)}
.hint{font-size:12px;color:var(--muted)}
.sig{position:fixed;left:12px;top:12px;font-size:12px;color:var(--muted);z-index:10}
.sig b{color:var(--accent)}
.mood{position:fixed;right:12px;top:12px;display:flex;gap:8px;z-index:10}
.mood button{width:26px;height:26px;border-radius:50%;border:2px solid rgba(255,255,255,.5);cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,.25)}
.mood .night{background:#1c1f2d}.mood .spring{background:#52d6a0}.mood .gulabi{background:#ff8fb1}.mood .denim{background:#85a9ff}.mood .dusk{background:#bca2ff}

/* Stars + sky */
.stars{position:fixed;inset:0;pointer-events:none;z-index:-2;opacity:.85;
  background:
    radial-gradient(2px 2px at 18% 28%,#fff,transparent 60%),
    radial-gradient(2px 2px at 78% 22%,#fff,transparent 60%),
    radial-gradient(1.5px 1.5px at 32% 72%,#fff,transparent 60%),
    radial-gradient(1.5px 1.5px at 64% 64%,#fff,transparent 60%),
    radial-gradient(1.5px 1.5px at 52% 48%,#fff,transparent 60%);
  animation:twinkle 6s ease-in-out infinite alternate}
@keyframes twinkle{from{opacity:.6}to{opacity:1}}
#trail,#nameConstellation{position:fixed;inset:0;pointer-events:none;z-index:0;mix-blend-mode:screen;opacity:.95}

/* Petals */
#petals{position:fixed;inset:0;pointer-events:none;z-index:1}
.petal{position:fixed;top:-40px;width:14px;height:14px;background:radial-gradient(circle at 30% 30%,#fff,transparent 60%),var(--petal);
  border-radius:42% 58% 58% 42%/64% 62% 38% 36%;opacity:.75;filter:drop-shadow(0 8px 10px rgba(255,200,221,.25))}

/* Landing */
.title{font-size:clamp(24px,6vw,40px);line-height:1.28;margin:0 0 12px}
.lead{max-width:740px;margin:0 auto 16px}
.cta{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}

/* Diya */
.diya{width:140px;height:140px;position:relative;filter:drop-shadow(0 28px 40px rgba(246,208,110,.22));transform:translateY(6px) scale(.96);transition:.7s ease}
.bowl{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);width:130px;height:56px;background:radial-gradient(130px 56px at 50% 0%,#6b3b1b,#341c0f 70%);border-radius:80px 80px 30px 30px/40px 40px 30px 30px;box-shadow:inset 0 10px 24px rgba(255,255,255,.06)}
.oil{position:absolute;bottom:32px;left:50%;transform:translateX(-50%);width:110px;height:18px;background:radial-gradient(110px 18px at 50% 60%,#2c1409,#120803 70%);border-radius:999px}
.flame{position:absolute;left:50%;bottom:52px;transform:translateX(-50%) rotate(-2deg);width:20px;height:34px;background:radial-gradient(ellipse at 50% 20%,#fff6b0,#ffd275 40%,rgba(255,120,64,.9) 70%,rgba(255,120,64,0) 75%);border-radius:50%/70% 70% 30% 30%;opacity:0}
.glow{position:absolute;left:50%;bottom:52px;transform:translateX(-50%);width:110px;height:110px;border-radius:50%;background:radial-gradient(closest-side,rgba(255,214,110,.42),rgba(255,214,110,0));opacity:0}
.lit{transform:translateY(0) scale(1)}
.lit .flame{animation:flicker .18s infinite alternate .1s;opacity:1}
.lit .glow{animation:glow 1.2s ease-in-out infinite alternate .1s;opacity:1}
@keyframes flicker{from{transform:translateX(-50%) rotate(-2deg) scaleY(1)}to{transform:translateX(-50%) rotate(2deg) scaleY(1.07)}}
@keyframes glow{from{transform:translateX(-50%) scale(.9)}to{transform:translateX(-50%) scale(1.05)}}

/* Balloons + modal */
.balloon-area{position:relative;height:64vh;max-height:640px;width:100%;overflow:hidden;border-radius:18px;border:1px solid var(--edge);
  background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.02));box-shadow:inset 0 1px 0 rgba(255,255,255,.04)}
.balloon{
  --c:#ff9ccc; --delay:0; --x:10;
  position:absolute; bottom:-150px; left:calc(var(--x)*1%);
  width:88px; height:112px; border-radius:50% 50% 45% 45%/55% 55% 45% 45%;
  background:radial-gradient(circle at 30% 30%,#fff8,transparent 60%),var(--c);
  border:1px solid rgba(255,255,255,.25);
  box-shadow:inset -10px -16px 24px rgba(0,0,0,.18), inset 0 12px 26px rgba(255,255,255,.12), 0 10px 30px rgba(0,0,0,.22);
  animation:floatUp 26s linear infinite; animation-delay:calc(var(--delay)*1s);
  display:grid;place-items:center;color:#0c0e1a;font-weight:900;text-shadow:0 1px 0 #ffffff88;cursor:pointer;
}
.balloon::after{content:"";position:absolute;width:2px;height:140px;background:rgba(255,255,255,.3);left:50%;bottom:-140px}
.balloon span{background:#fff;padding:6px 10px;border-radius:999px;font-size:14px;box-shadow:0 4px 10px rgba(0,0,0,.08)}
@keyframes floatUp{from{transform:translateY(0)}to{transform:translateY(-105vh)}}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:50}
.modal.show{display:flex}
.dialog{max-width:560px;margin:16px;background:linear-gradient(180deg,#0e1628,#0c1323);border:1px solid var(--edge);border-radius:18px;padding:18px;text-align:center;box-shadow:0 18px 40px rgba(0,0,0,.44)}
.dialog h4{margin:.25rem 0 .5rem;font-size:20px}
.dialog p{margin:0;color:var(--muted)}

/* Greeting cards ‚Äî FLIP */
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,5fr));gap:14px;width:min(100%,1080px)}
.flip-card{perspective:1200px}
.flip-inner{position:relative;transform-style:preserve-3d;transition:transform .6s cubic-bezier(.2,.7,.2,1)}
.flip-card.open .flip-inner{transform:rotateY(180deg)}
.face{backface-visibility:hidden;border-radius:16px;border:1px solid var(--edge);box-shadow:0 16px 38px rgba(0,0,0,.35)}
.face.front{padding:18px;background:linear-gradient(180deg,var(--card),var(--card2))}
.face.back{padding:4px;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));position:absolute;inset:0;transform:rotateY(180deg)}
.face h3{margin:.3rem 0 .4rem;font-family:"Caveat",cursive;font-size:24px;color:var(--accent)}
.face p{margin:.2rem 0 .2rem;line-height:1.7}
.openHint{font-size:12px;color:var(--muted);margin-top:6px}

/* Spotlight */
.gallery{display:grid;gap:12px}
.hero{position:relative;border-radius:20px;overflow:hidden;height:min(60vh,520px)}
.hero img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;transform:scale(1.06);animation:ken 14s ease-in-out infinite}
@keyframes ken{0%{transform:scale(1.04)}50%{transform:scale(1.1) translate(-1%,-1%)}100%{transform:scale(1.04)}}
.hero canvas#stardust { position:absolute; inset:0; pointer-events:none; mix-blend-mode:screen; }

/* Polaroids (larger for readability) */
.polaroids{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}
.pol{height:220px;border-radius:12px;overflow:hidden;border:2px solid transparent;background:#fff0;cursor:grab;transform:rotate(var(--r,0deg)) scale(1);transition:transform .18s ease, box-shadow .18s ease}
.pol img{width:100%;height:100%;object-fit:cover}
.pol.active{border-color:var(--accent)}
.pol:hover{transform:translateY(-2px) rotate(var(--r,0deg));box-shadow:0 14px 30px rgba(0,0,0,.26)}
.lightbox{display:none;position:fixed;inset:0;background:rgba(0,0,0,.86);z-index:60;align-items:center;justify-content:center}
.lightbox img{max-width:192vw;max-height:186vh;border-radius:114px;border:1px solid var(--edge);box-shadow:0 22px 60px rgba(0,0,0,.6)}
.lightbox .x{position:absolute;top:12px;right:12px}

/* ---------- 3D BOOK (fixed) ---------- */
#lines .bookStage{
  --bookW:min(92vw,560px);
  --bookH:clamp(320px,56vw,420px);
  display:grid; grid-template-rows:var(--bookH) auto;
  row-gap:12px; justify-items:center;
}
#lines .bookWrap{ position:relative; width:var(--bookW); height:var(--bookH); perspective:1400px; }

#lines .book3d{
  position:absolute; inset:0; z-index:1;               /* book below wrap */
  border-radius:18px; overflow:hidden;
  box-shadow:0 18px 44px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
  background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
}
#lines .book{ position:absolute; inset:0; border-radius:18px; transform-style:preserve-3d; overflow:hidden; }
#lines .cover{ position:absolute; inset:0; border-radius:18px; backface-visibility:hidden; will-change:transform; }
#lines .coverLeft{
  width:50%; left:0; border-right:1px solid rgba(255,255,255,.08);
  background:linear-gradient(90deg, rgba(0,0,0,.22), rgba(255,255,255,.06) 30%, rgba(255,255,255,0) 60%),
             linear-gradient(180deg, #0f172a, #0c1323);
  box-shadow:inset -12px 0 24px rgba(0,0,0,.35);
}
#lines .coverRight{
  width:50%; right:0; transform-origin:left center;
  background:linear-gradient(90deg, rgba(255,255,255,.08), rgba(255,255,255,0)),
             linear-gradient(180deg, #121b30, #0c1323);
  box-shadow:inset 12px 0 22px rgba(0,0,0,.35);
}
#lines .bookWrap.open #coverRight{
  transition:transform .9s cubic-bezier(.2,.75,.2,1);
  transform:rotateY(-160deg); pointer-events:none;
}

#lines .pages{ position:absolute; inset:0; }
#lines .page{ position:absolute; top:0; bottom:0; width:50%; }
#lines .page.left{ left:0; border-right:1px solid rgba(255,255,255,.08); cursor:w-resize; }
#lines .page.right{ right:0; cursor:e-resize; }
#lines .pageInner{
  position:absolute; inset:14px; border-radius:14px;
  background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));
  border:1px solid var(--edge); display:grid; place-items:center; text-align:center; padding:20px;
}
#lines .quote{
  font-family:"Satisfy","Caveat",cursive; font-weight:400; line-height:1.5;
  font-size:clamp(20px,4.8vw,28px); letter-spacing:.2px; color:var(--ink);
  text-shadow:0 1px 14px rgba(0,0,0,.22); white-space:pre-wrap; word-break:break-word;
}

/* flipping sheet that goes above pages during turn */
#lines .flipSheet{
  position:absolute; right:0; top:0; bottom:0; width:50%;
  transform-origin:left center; backface-visibility:hidden;
  background:linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.03));
  border-left:1px solid rgba(255,255,255,.08);
  box-shadow:0 22px 40px rgba(0,0,0,.45);
  z-index:20; display:none; pointer-events:none;
}
#lines .flipSheet.show{ display:block }
@keyframes turnRightToLeft{
  0%{ transform:rotateY(0deg);   box-shadow:0 22px 40px rgba(0,0,0,.45); }
  100%{transform:rotateY(-180deg); box-shadow:-10px 22px 40px rgba(0,0,0,.25); }
}
#lines .flipSheet.animating{ animation:turnRightToLeft .9s ease both }
@keyframes turnLeftToRight{
  0%{ transform:rotateY(-180deg); box-shadow:-10px 22px 40px rgba(0,0,0,.25); }
  100%{transform:rotateY(0deg);    box-shadow:0 22px 40px rgba(0,0,0,.45); }
}
#lines .flipSheet.reverse{ animation:turnLeftToRight .9s ease both }

/* --- gift ribbon + seal (above book) --- */
#lines .ribbon{ position:absolute; inset:0; display:grid; place-items:center; z-index:30; }
#lines .ribbon .r{
  position:absolute; background:linear-gradient(90deg,#ff9ccc,#c9a7ff);
  filter:drop-shadow(0 6px 12px rgba(0,0,0,.35)); pointer-events:none;
  transition:transform .55s cubic-bezier(.2,.75,.2,1), opacity .35s ease;
  will-change:transform,opacity;
}
#lines .ribbon .r.h{ height:10px; left:0; right:0; top:calc(50% - 5px); }
#lines .ribbon .r.v{ width:10px;  top:0; bottom:0; left:calc(50% - 5px); }

#lines .seal{
  width:66px; height:66px; border-radius:50%; border:0; cursor:pointer;
  background: radial-gradient(circle at 30% 30%, #fff6, transparent 60%),
              radial-gradient(closest-side,#ff6a8e,#ff2f68);
  box-shadow:0 12px 24px rgba(0,0,0,.35), inset 0 3px 6px rgba(255,255,255,.25);
  transition:transform .55s cubic-bezier(.2,.75,.2,1), opacity .35s ease;
  will-change:transform,opacity;
}

/* when JS adds .unwrap, animate the ribbon away */
#lines .ribbon.unwrap{ pointer-events:none; }
#lines .ribbon.unwrap .r.h{ transform:scaleX(0); opacity:0; transform-origin:center; }
#lines .ribbon.unwrap .r.v{ transform:scaleY(0); opacity:0; transform-origin:center; }
#lines .ribbon.unwrap .seal{ transform:scale(.7); opacity:0; }

/* dots bar */
#lines .bookFoot{ width:var(--bookW); text-align:center }
#lines .dots{ display:flex; gap:6px; justify-content:center }
#lines .dots i{ width:8px; height:8px; border-radius:50%; background:rgba(255,255,255,.28) }
#lines .dots i.on{ background:linear-gradient(90deg,#ff9ccc,#c9a7ff) }

/* quill (RIGHT page only) ‚Äî always on top */
#quill{
  position:absolute; width:36px; height:36px;
  transform:translate(-50%,40%) rotate(-5deg);
  pointer-events:none; z-index:40; opacity:0;
  transition:transform .1s linear, opacity .25s ease;
  background-repeat:no-repeat; background-size:contain;
  background-image:url('data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2264%22 height=%2264%22 viewBox=%220 0 64 64%22><g fill=%22none%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><path d=%22M9 55 C22 40, 36 26, 55 9%22 stroke=%22%2321a886%22 stroke-width=%223%22/><path d=%22M17 48 C30 36, 42 25, 53 16%22 stroke=%22%2385e0c9%22 stroke-width=%222%22/><path d=%22M36 22 c8 -8 18 -8 20 -6 c2 2 2 12 -6 20 c-4 4 -10 6 -14 4 c-4 -2 -4 -10 0 -18z%22 fill=%22%231058aa%22 opacity=%22.8%22/></g></svg>');
}
#rightInner{ position:relative; } /* anchor for the quill */

/* Final */
#fire{position:absolute;inset:0;pointer-events:none}
.final p{font-size:clamp(18px,3.6vw,22px);line-height:1.6}

/* Welcome Gate */
body.gated { overflow:hidden; overscroll-behavior:contain; touch-action:none; }
.gate{position:fixed; inset:0; z-index:9999; display:flex; align-items:center; justify-content:center;
  background: radial-gradient(900px 440px at 50% -12%, rgba(155,211,255,.18), transparent 60%),
              linear-gradient(180deg,var(--bg1),var(--bg2));
  backdrop-filter: blur(6px); transition: opacity .45s ease; animation: gateFade .45s ease both;}
.gate.hide{opacity:0;pointer-events:none}
.gate-card{width:min(560px,92vw); padding:18px; text-align:center; border-radius:18px; border:1px solid var(--edge);
  background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03)); box-shadow:0 22px 48px rgba(0,0,0,.45);
  transform: translateY(6px) scale(.94); animation: gatePop .45s cubic-bezier(.2,.75,.2,1) .05s both;}
.gate-card h1{margin:.2rem 0 .3rem;font-size:clamp(22px,5.2vw,32px)}
.gate-card p{margin:.2rem 0;color:var(--muted)}
.gate-actions{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:12px}
@keyframes gateFade { from{opacity:0} to{opacity:1} }
@keyframes gatePop  { from{opacity:0; transform:translateY(10px) scale(.94)} to{opacity:1; transform:none} }

@media (max-width:560px){ .polaroids{grid-template-columns:repeat(2,1fr)} }

/* ---------- 3D Paper for Final message ---------- */
#final .paper3d{
  perspective: 1400px;
  width: min(980px, 94vw);
  margin-inline: auto;
  position: relative;
  z-index: 2;               /* above fireworks canvas */
  display: grid;
  place-items: center;
}

/* --- 3D paper: use the original dark / glass look --- */
#final .paper{
  /* colors back to theme */
  color: var(--ink);
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); /* same as .soft */
  border: 1px solid var(--edge);
  box-shadow: 0 26px 60px rgba(0,0,0,.38), inset 0 1px 0 rgba(255,255,255,.04);
}

#final .paper::before{            /* darker inner vignette */
  box-shadow: inset 0 14px 26px rgba(0,0,0,.22),
              inset 0 -14px 26px rgba(0,0,0,.18);
}

#final .paper::after{             /* faint paper texture, subtle + dark */
  background-image:
    radial-gradient(1px 1px at 12% 18%, rgba(255,255,255,.05) 30%, transparent 31%),
    radial-gradient(1px 1px at 72% 82%, rgba(255,255,255,.04) 30%, transparent 31%);
  opacity:.15;
  mix-blend-mode: screen;
}

/* heading colors back to ‚Äúnight‚Äù theme */
#final .paper h2{ color: var(--ink); }
#final .paper h2 span{ color: var(--accent); }


/* keep the buttons under the paper nicely spaced */
#final .cta{ margin-top: 18px; }

/* reduce motion: freeze the tilt */
@media (prefers-reduced-motion: reduce){
  #final .paper{ transform: none !important; }
}

</style>
</head>

<body class="gated">

<!-- Background song (starts on gate enter) -->
<audio id="bgSong" preload="auto" loop>
  <source src="public/audio/ilovebloemstore.co.za - KK Zara Sa - Audio Lyrical Emraan Hashmi Sonal Chauhan Pritam Sayeed Quadri Jannat (320 KBps).mp3" type="audio/mpeg">
</audio>

<!-- Welcome Gate -->
<div class="gate" id="gate" role="dialog" aria-modal="true">
  <div class="gate-card soft">
    <h1>Happy Birthday, Dear Laadli Madamji üéÄüéÇ</h1>
    <p>Only pure and warm wishes for you today ü§å‚ú®: Hope your smile stays constant while you read this.</p>
    <p class="muted">I‚Äôll stay in the background ‚Äî no demands, just your quiet cheer squad üëÄ.</p>
    <div class="gate-actions">
      <button class="btn" id="enterBtn" type="button" onclick="window.__GateClick && window.__GateClick(event)">
        Enter the little night ‚Üí üéµ
      </button>
      
    </div>
    <p class="hint">Ignore karogi toh bhi theek hai ‚Äî main wohi silly boy hoon jo giving-up ke mood me nahi hota ü´†.</p>
  </div>
</div>
<script>
  /* Bullet-proof gate: works on iOS/Android/desktop + in-app browsers */
  (function gateWiring(){
    const gate = document.getElementById('gate');
    const btn  = document.getElementById('enterBtn');
    if (!gate || !btn) return;
  
    let entered = false;
  
    function hideGate(){
      if (gate.classList.contains('hide')) return;
      gate.classList.add('hide');
      document.body.classList.remove('gated');
      try { localStorage.setItem('gateEntered','1'); } catch {}
      setTimeout(()=>{ try{ gate.remove(); }catch{} }, 450);
    }
  
    async function go(e){
      try { e?.preventDefault?.(); e?.stopPropagation?.(); } catch {}
      if (entered) return;
      entered = true;
  
      // Kick off audio/ambience, but *never* let it block the UI
      const enterP = (typeof window.enterGate === 'function'
        ? Promise.resolve(window.enterGate())
        : (async () => { try{ window.playBgSongFadeIn?.(); }catch{} try{ window.startAmbience?.(); }catch{} })()
      );
      hideGate();
      enterP.catch(()=>{}); // swallow autoplay errors etc.
    }
  
    // Inline fallback target (used by onclick on the button)
    window.__GateClick = go;
  
    // Primary bindings (broad coverage)
    const opts = { passive:false };
    ['click','pointerup','pointerdown','touchend','touchstart'].forEach(ev => btn.addEventListener(ev, go, opts));
    btn.addEventListener('keydown', e => { if (e.key==='Enter' || e.key===' ') go(e); });
  
    // Tap outside card also enters
    gate.addEventListener('click', e => { if (e.target === gate) go(e); }, { passive:true });
  
    // Last-resort: first interaction anywhere enters (covers odd in-app browsers)
    const once = () => { document.removeEventListener('touchstart', once, true); document.removeEventListener('mousedown', once, true); go(); };
    document.addEventListener('touchstart', once, true);
    document.addEventListener('mousedown', once, true);
  })();
  </script>
  
   

<!-- Top chrome -->
<div class="sig"> I made this with <b>pure efforts</b> & <b>care.</b><b> So please dont judge!üòÖ</b></div>
<div class="mood" role="toolbar" aria-label="Theme">
  <button class="night" title="Night"  onclick="setMood('night')"></button>
  <button class="spring" title="Spring" onclick="setMood('spring')"></button>
  <button class="gulabi" title="Gulabi" onclick="setMood('gulabi')"></button>
  <button class="denim"  title="Denim"  onclick="setMood('denim')"></button>
  <button class="dusk"   title="Dusk"   onclick="setMood('dusk')"></button>
</div>

<!-- Sky layers -->
<canvas id="trail" aria-hidden="true"></canvas>
<canvas id="nameConstellation" aria-hidden="true"></canvas>
<div class="stars" aria-hidden="true"></div>
<div id="petals" aria-hidden="true"></div>

<!-- 1) Landing -->
<section class="section" id="home">
  <div class="container center">
    <h1 class="title">On this small night, the universe plays its sweetest tune‚Ä¶</h1>
    <p class="lead muted">‚Ä¶because it‚Äôs your day, Madamjiüòã</p>
    <div class="cta">
      <a class="btn" href="#spark" id="walkBtn"> Wanna walk with me ? ‚Üí</a>
    </div>
  </div>
</section>

<!-- 2) Spark (diya + assurance) -->
<section class="section" id="spark">
  <div class="container center">
    <div class="diya soft" id="diya" title="Long-press me">
      <div class="bowl"></div><div class="oil"></div><div class="flame"></div><div class="glow"></div>
    </div>
    <p id="assureLine" class="muted" style="max-width:740px;margin:16px auto 6px"></p>
    <div class="cta"><a class="btn" href="#blessings">Next ‚Üí</a></div>
  </div>
</section>

<!-- 3) Blessings -->
<section class="section" id="blessings">
  <div class="container" style="width:min(90%,800px)">
    <h2 class="center" style="margin-bottom:14px;color:var(--accent)">Playful Aashirwad</h2>
    <div class="balloon-area" id="balloonArea" aria-label="Blessing balloons"></div>
    <p class="hint center">Tap a balloon to pop it. Ramji ka naam lo blessings lapetlo.</p>
    <div class="center" style="margin-top:30px"><a class="btn" href="#cards">Next ‚Üí</a></div>
  </div>
  <div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="dialog">
      <h4 id="modalTitle">A note</h4>
      <p id="modalMsg">You are loved.</p>
      <button class="btn" id="modalClose" style="margin-top:30px">Close</button>
    </div>
  </div>
</section>

<!-- 4) Greeting Cards -->
<section class="section" id="cards">
  <div class="container center">
    <h2 style="margin:.2rem 0 .6rem;color:var(--accent)">Small Birthday Cards</h2>
    <p class="muted" style="margin-top:-6px">Tap to flip ‚Äî thodasa sukoon bhi aur thodasa fun</p>
    <div class="cards" id="cardsWrap"></div>
    <div class="cta" style="margin-top:14px"><a class="btn" href="#spotlight">Next ‚Üí</a></div>
  </div>
</section>

<!-- 5) Spotlight -->
<section class="section" id="spotlight">
  <div class="container">
    <div class="gallery">
      <div class="hero soft">
        <img id="hero" alt="her photo" src="public/images/madamji1.jpg">
        <canvas id="stardust"></canvas>
      </div>
      <div class="polaroids" id="polaroids"></div>
      <div class="center" style="margin-top:8px">
        <button class="btn" id="openRing3D">Try 3D photo ring ‚ú®</button>
      </div>
      <p class="hint center">Every picture whispers: ‚Äúyou‚Äôre an absolute trouble ‚Äî but the good kind, Madamji.‚Äù</p>
      <div class="center" style="margin-top:10px"><a class="btn" href="#lines">Next ‚Üí</a></div>
    </div>
  </div>
</section>

<!-- 6) 3D Book with quill (right side only) -->
<section class="section" id="lines">
  <div class="container">
    <div class="bookStage" aria-live="polite">
      <div class="bookWrap" id="bookWrap">
        <!-- Ribbon + seal -->
        <div class="ribbon" id="ribbon">
          <span class="r h"></span>
          <span class="r v"></span>
          <button class="seal" id="sealBtn" type="button" aria-label="Open the gift"></button>
        </div>

        <!-- Book -->
        <div class="book3d" id="book3d" aria-hidden="true">
          <div class="book">
            <div class="cover coverLeft"></div>
            <div class="cover coverRight" id="coverRight"></div>

            <div class="pages">
              <div class="page left" id="leftPage">
                <div class="pageInner">
                  <p class="quote" id="leftText"></p>
                </div>
              </div>

              <div class="page right" id="rightPage">
                <div class="pageInner" id="rightInner">
                  <p class="quote" id="rightText">Tap the seal to open.</p>
                  <!-- SINGLE quill element anchored here -->
                  <span id="quill" aria-hidden="true"></span>
                </div>
              </div>
            </div>

            <div class="flipSheet" id="flipSheet"></div>
          </div>
        </div>
      </div>

      <div class="bookFoot">
        <div class="dots" id="dots"></div>
        <div class="hint muted" id="bookHint">Tap the seal to unwrap. Tap the right page to turn.</div>
      </div>
    </div>

    <div class="center" style="margin-top:30px">
      <a class="btn" href="#divine">Next ‚Üí</a>
    </div>
  </div>
</section>

<!-- 7) Divine blessing -->
<section class="section" id="divine">
  <div class="container center soft" style="padding:50px">
    <h2 style="margin:.10rem 0;color:var(--accent)">A small prayer </h2>
    <p class="muted" style="max-width:740px;margin:6px auto 0">
      May Kanhaji always keep mischief in your smile and peace in your steps, and may Bajrangbali cover you with courage on your every step.
      May your days be soft where you need softness and strong where you need strength üôáüôè.
    </p>
    <div style="margin-top:30px"><a class="btn" href="#final">Final page ‚Üí</a></div>
  </div>
</section>

<!-- Finale -->
<section class="section final" id="final" style="overflow:hidden">
  <canvas id="fire" aria-hidden="true"></canvas>
  <div class="container center">
    <div class="paper3d">
      <article class="paper soft" id="finalPaper" aria-label="Promise note">
        <h2>Happy Birthday, <span id="herName">SHRUTI üíó </span>!</h2>
        <p id="promiseLine">
          Happy Birthday once again, Madamji!‚ú®

          Today I just want to make one clear promise: I won‚Äôt rush, I won‚Äôt pull ‚Äî your pace will always be mine too.
          If ever I irritate you, just tell me straight ‚Äî I‚Äôll listen.
          
          You‚Äôll always be in my prayers. If joy comes, share it with me; if tension comes, share that too. Respect, care, and prayers ‚Äî these three things you‚Äôll always have from me, daily, guaranteed.
          
          Baaki, I‚Äôll keep showing up quietly with the same energy‚Ä¶ you just keep smiling. üôÇ
    </p>
  </article>
</div>

<div class="cta">
  <button class="btn" id="gift">Shower of cute things üéÅ</button>
  <button class="btn" id="savePNG">Save this promise (PNG)</button>
</div>
</div>
</section>

<!-- Lightbox -->
<div class="lightbox" id="lb"><img id="lbImg" alt=""><button class="btn x" onclick="closeLB()">Close ‚úñ</button></div>

<!-- 3D Photo Ring overlay (Three.js module import kept only for this) -->
<div id="ring3d" style="display:none; position:fixed; inset:0; background:#000a; z-index:90; align-items:center; justify-content:center">
  <div style="width:min(900px,94vw); aspect-ratio:16/9; background:#000; border:1px solid rgba(255,255,255,.18); border-radius:14px; overflow:hidden; position:relative">
    <canvas id="ringCanvas"></canvas>
    <button class="btn" style="position:absolute; right:10px; top:10px" onclick="closeRing3D()">Close ‚úñ</button>
  </div>
</div>

<!-- Three.js (only for the ring overlay) -->
<script type="module">
  import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
  window.THREE = THREE;
</script>

<script>
/* =============== helpers & theme =============== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const prefersReduced = matchMedia('(prefers-reduced-motion:reduce)').matches;

function setMood(m){
  document.body.className = document.body.className.replace(/\b(gulabi|denim|spring|dusk)\b/g,'').trim();
  if(m && m!=='night') document.body.classList.add(m);
  localStorage.setItem('mood',m||'night');
}
(function initMood(){ setMood(localStorage.getItem('mood')||'night'); })();

/* palette for fireworks/stardust per theme */
function themePalette(){
  const b=document.body;
  if(b.classList.contains('spring')) return ['82,214,160','255,216,110','255,183,197','200,228,255'];
  if(b.classList.contains('gulabi')) return ['255,150,200','255,200,221','201,167,255','246,208,110'];
  if(b.classList.contains('denim'))  return ['133,169,255','200,220,255','255,200,221','180,220,255'];
  if(b.classList.contains('dusk'))   return ['188,162,255','255,210,230','150,200,255','255,186,120'];
  return ['255,200,221','255,168,194','201,167,255','246,208,110']; // night default
}

/* =============== stars, petals, constellation =============== */
(function petals(){
  const wrap = $('#petals');
  for(let i=0;i<(prefersReduced?8:22);i++){
    const p=document.createElement('div'); p.className='petal';
    p.style.left=(Math.random()*100)+'vw';
    const dur=11000+Math.random()*9000, delay=Math.random()*4000, drift=(Math.random()<.5?-1:1)*(8+Math.random()*10);
    p.animate([{transform:'translate(0,0) rotate(0deg)',top:'-40px'},{transform:`translate(${drift}vw,110vh) rotate(${Math.random()*360}deg)`,top:'110vh'}],
              {duration:dur,delay,iterations:Infinity,easing:'ease-in'});
    wrap.appendChild(p);
  }
})();
(function starTrail(){
  const c=$('#trail'), ctx=c.getContext('2d'); let W,H; const parts=[];
  function fit(){ c.width=innerWidth; c.height=innerHeight } fit(); addEventListener('resize',fit,{passive:true});
  function spawn(x,y){ parts.push({x,y,vx:(Math.random()-0.5)*1.2,vy:(Math.random()-0.5)*1.2,life:40}); }
  function draw(){ ctx.clearRect(0,0,W=c.width,H=c.height); for(let i=parts.length-1;i>=0;i--){ const p=parts[i]; p.x+=p.vx; p.y+=p.vy; p.life--; ctx.fillStyle=`rgba(255,210,230,${p.life/40})`; ctx.fillRect(p.x,p.y,2,2); if(p.life<=0) parts.splice(i,1); } requestAnimationFrame(draw) } draw();
  let timer=null;
  function touch(e){ const t=e.touches?e.touches[0]:e; spawn(t.clientX,t.clientY); if(timer) clearTimeout(timer); timer=setTimeout(()=> nameConstellation($('#herName').textContent||'Shruti'), 1400); }
  addEventListener('mousemove',touch,{passive:true}); addEventListener('touchmove',touch,{passive:true});
})();
function nameConstellation(name){
  const cvs=$('#nameConstellation'), ctx=cvs.getContext('2d'); cvs.width=innerWidth; cvs.height=innerHeight;
  const fam='Quicksand, ui-sans-serif, system-ui';
  function lines(t){ t=(t||'You').trim().replace(/\s+/g,' '); if(t.length<=14) return [t]; const mid=Math.floor(t.length/2); let s=t.lastIndexOf(' ',mid); if(s<6||t.length-s<6) s=t.indexOf(' ',mid); return s>0?[t.slice(0,s),t.slice(s+1)]:[t]; }
  function targets(ls,density=22){
    const off=document.createElement('canvas'), o=off.getContext('2d'); off.width=cvs.width; off.height=cvs.height;
    let fs=Math.min(220,Math.max(84,off.width*0.18)), maxW=off.width*.84; function w(t){o.font=`800 ${fs}px ${fam}`; return o.measureText(t).width}
    while(Math.max(...ls.map(w))>maxW&&fs>36) fs-=2;
    o.textAlign='center'; o.textBaseline='middle'; o.fillStyle='#fff'; o.font=`800 ${fs}px ${fam}`;
    const midY=off.height*.42, gap=fs*1.18; ls.forEach((t,i)=>o.fillText(t,off.width/2,midY+(i-(ls.length-1)/2)*gap));
    const data=o.getImageData(0,0,off.width,off.height).data, arr=[], step=Math.max(1,Math.floor(fs/density));
    for(let y=0;y<off.height;y+=step) for(let x=0;x<off.width;x+=step) if(data[(y*off.width+x)*4+3]>128) arr.push({x,y});
    return arr;
  }
  const cloud=targets(lines(name)); const N=Math.min(560,Math.max(220,Math.floor(cloud.length*.55)));
  const pts=[]; for(let i=0;i<N;i++){ const t=cloud[Math.floor(i*(cloud.length/N))]||{x:Math.random()*cvs.width,y:Math.random()*cvs.height}; pts.push({x:Math.random()*cvs.width,y:Math.random()*cvs.height*0.8+cvs.height*0.1, tx:t.x, ty:t.y}); }
  let phase='in', t0=performance.now();
  (function frame(t){
    ctx.clearRect(0,0,cvs.width,cvs.height);
    for(const p of pts){ p.x+=(p.tx-p.x)*0.08; p.y+=(p.ty-p.y)*0.08; ctx.fillStyle='rgba(255,210,230,.95)'; ctx.fillRect(p.x,p.y,2,2); }
    if(phase==='in' && t-t0>3800){ phase='out'; pts.forEach(p=>{ p.tx=Math.random()*cvs.width; p.ty=Math.random()*cvs.height*0.8+cvs.height*0.1; }); }
    if(phase==='out' && !pts.some(p=>Math.hypot(p.tx-p.x,p.ty-p.y)>0.6)){ ctx.clearRect(0,0,cvs.width,cvs.height); return; }
    requestAnimationFrame(frame);
  })(t0);
}

/* =============== Diya (fixed typed text) =============== */
const ASSURE_TEXT = "Laadliji, the diya is lit for you here‚Äîlittle flame, big faith. If the world gets loud, come sit by this calm; Kanhaji will cover you with His grace. ‚ú®";
const sparkIO=new IntersectionObserver(es=>{ es.forEach(e=>{ if(e.isIntersecting){ $('#diya').classList.add('lit'); typeAssure(); sparkIO.unobserve($('#spark')); } }); },{threshold:.45});
sparkIO.observe($('#spark'));
function typeAssure(){ const el=$('#assureLine'); el.textContent=''; let i=0; const id=setInterval(()=>{ el.textContent+=ASSURE_TEXT.charAt(i++); if(i>=ASSURE_TEXT.length) clearInterval(id); },26); }
(function longPress(){
  const el=$('#diya'); let timer=null;
  const open=()=>showModal('A small note','Space chahiye toh milegi. Main bas background me diya jala ke rakhoonga.');
  el.addEventListener('pointerdown',()=>{ timer=setTimeout(open,650); },{passive:true});
  ['pointerup','pointerleave','pointercancel'].forEach(ev=> el.addEventListener(ev,()=>clearTimeout(timer),{passive:true}));
})();

/* =============== Blessings =============== */
const blessings=[{word:'Peace',color:'#ff9ccc',msg:'Let the noise fall away. May your nights be soft, your mornings unhurried, and your mind find its quiet corner.'},{word:'Courage',color:'#9bd3ff',msg:'When it feels heavy, text or don‚Äôt‚Äîeither way I‚Äôm in your corner. Tiny steps still count; we‚Äôll move the day gently.'},{word:'Trust',color:'#c9a7ff',msg:'No speeches, no drama‚Äîjust showing up the same way, every day. You can lean on that rhythm whenever you want.'},{word:'Joy',color:'#7ee6c9',msg:'More random giggles, more little wins, more songs stuck in your head. If the day is dull, I‚Äôll add color, not pressure.'},{word:'Health',color:'#ffd86e',msg:'Deep sleep, easy breath, light body. May your energy refill quietly and stay with you longer than deadlines do.'},{word:'Grace',color:'#ffb6a3',msg:'A soft shield around you and doors opening at the right time. May kindness follow you home and stay forever.'}];
let balloonsInit=false;
function spawnBalloons(){ if(balloonsInit) return; balloonsInit=true; const area=$('#balloonArea'); const cols=[8,24,40,56,72,88];
  blessings.forEach((b,i)=>{ const d=document.createElement('button'); d.className='balloon'; d.style.setProperty('--c',b.color); d.style.setProperty('--x', cols[i%cols.length]); d.style.setProperty('--delay', i*3); d.innerHTML=`<span>${b.word}</span>`; d.addEventListener('click',()=>{ popBlessing(d,b); },{passive:true}); area.appendChild(d); });}
function popBlessing(el,b){ try{navigator.vibrate&&navigator.vibrate(12);}catch{} el.animate([{transform:'scale(1)'},{transform:'scale(1.2)'},{transform:'scale(0)'}],{duration:260,easing:'ease-in'}); setTimeout(()=>el.remove(),220); playChime(); showModal(b.word,b.msg); }
function showModal(title,msg){ $('#modalTitle').textContent=title; $('#modalMsg').textContent=msg; $('#modal').classList.add('show'); }
$('#modal').addEventListener('click',(e)=>{ if(e.target.id==='modal'||e.target.id==='modalClose') $('#modal').classList.remove('show'); });
new IntersectionObserver(es=>es.forEach(e=>e.isIntersecting&&spawnBalloons()),{threshold:.4}).observe($('#blessings'));

/* =============== Greeting cards =============== */
const greetingCards=[{title:'Nazar Na Lage üßø',text:'May jealous eyes just slide off from you. May Kanhaji holds the roof, I‚Äôll hold the door. Walk light, consider yourself covered.'},{title:'Food + Calm ‚òïÔ∏è',text:'Morning breakfast or midnight munchings ‚Äî whatever you crave, I‚Äôll sort it. Ask if you want, or don‚Äôt; I‚Äôll read the vibe.'},{title:'Calendar Bless üìÖ',text:'Gentler Mondays, kinder deadlines, and random mid-week pauses. May meetings end early and kids trouble you less in school.'},{title:'Inbox of Joy üì´',text:'More ‚Äúgood news‚Äù pings, fewer ‚Äúurgent‚Äù ones. Spam blocked (except me haha), hope delivered. DMs get sunshine, not noise.'},{title:'Health & Glow ‚ú®',text:'Good Exercise, Deep sleep, easy breath, steady energy. May your body feel like home and your face keep that soft glow forever.'},{title:'Safe Roads üö¶',text:'Every route clear, timing right, people kind. Text back is optional ‚Äî arriving safe is the only update I might need.'}];
(function buildCards(){ const wrap=$('#cardsWrap'); greetingCards.forEach(c=>{ const card=document.createElement('article'); card.className='flip-card'; card.innerHTML=`<div class="flip-inner"><div class="face front"><h3>${c.title}</h3><p class="muted">Tap to open</p></div><div class="face back"><p>${c.text}</p><div class="openHint">Tap to close</div></div></div>`; card.addEventListener('click',()=>{ card.classList.toggle('open'); playChime(); }); wrap.appendChild(card); }); })();

/* =============== Spotlight photos (your uploads) =============== */
/* EDIT HERE: list your image files exactly as they are in /public/images */
const USER_PHOTOS = [
  // e.g. 'public/images/madamji1.jpg',
  //      'public/images/madamji2.jpg',
  //      'public/images/madamji3.jpg',
          'public/images/madamji4.jpg',
          'public/images/madamji4.jpg',
];

/* Build PHOTOS object array from your list */
const PHOTOS = USER_PHOTOS.map(src => ({ src }));

(function gallery () {
  const hero = document.getElementById('hero');
  const grid = document.getElementById('polaroids');

  // nothing uploaded yet?
  if (PHOTOS.length === 0) {
    // keep your current local hero src or a tiny message
    // (you can set a default local placeholder if you like)
    grid.innerHTML = `
      <div class="muted" style="grid-column:1/-1;text-align:center">
        Upload photos to <code>public/images/</code> and list them in <code>USER_PHOTOS</code> above.
      </div>`;
    // initialize stardust using whatever hero currently has
    initStardust(hero.getAttribute('src'));
    return;
  }

  // set hero to your first photo and build grid
  let cur = 0;
  hero.src = PHOTOS[0].src;

  grid.innerHTML = ''; // clear any placeholder
  PHOTOS.forEach((p, i) => {
    const d = document.createElement('div');
    d.className = 'pol';
    d.style.setProperty('--r', (Math.random() * 6 - 3) + 'deg');
    d.innerHTML = `<img src="${p.src}" alt="her ${i + 1}">`;

    d.addEventListener('click', () => {
      cur = i;
      hero.src = p.src;
      document.querySelectorAll('.pol').forEach(x => x.classList.remove('active'));
      d.classList.add('active');
    });

    // small drag play
    let drag = false, sx = 0, sy = 0;
    d.addEventListener('pointerdown', e => {
      drag = true; d.setPointerCapture(e.pointerId);
      sx = e.clientX; sy = e.clientY; d.style.transition = 'none';
    });
    d.addEventListener('pointermove', e => {
      if (!drag) return;
      const dx = e.clientX - sx, dy = e.clientY - sy;
      d.style.transform = `translate(${dx}px,${dy}px) rotate(var(--r))`;
    });
    d.addEventListener('pointerup', () => {
      drag = false; d.style.transition = 'transform .18s';
      d.style.transform = 'rotate(var(--r))';
    });

    d.addEventListener('dblclick', () => openLB(p.src));
    grid.appendChild(d);
  });

  hero.addEventListener('click', () => openLB(PHOTOS[cur]?.src || hero.src));

  // IMPORTANT: build stardust from the actual hero image (no remote CORS)
  hero.addEventListener('load', () => initStardust(hero.src), { once: true });
})();

function openLB(src) { document.getElementById('lbImg').src = src; document.getElementById('lb').style.display = 'flex'; }
function closeLB() { document.getElementById('lb').style.display = 'none'; }

/* =============== Stardust uses your local hero image =============== */
function initStardust(src) {
  const cvs = document.getElementById('stardust'); if (!cvs) return;
  const heroWrap = cvs.parentElement;

  function size() {
    cvs.width = heroWrap.clientWidth;
    cvs.height = heroWrap.clientHeight;
  }
  size(); addEventListener('resize', size);

  const ctx = cvs.getContext('2d');
  const img = new Image();
  img.src = src; // local same-origin path (no crossOrigin needed)

  img.onload = () => {
    const scale = Math.min(cvs.width / img.width, cvs.height / img.height);
    const w = img.width * scale, h = img.height * scale;
    const x = (cvs.width - w) / 2, y = (cvs.height - h) / 2;

    const off = document.createElement('canvas'); off.width = w; off.height = h;
    const octx = off.getContext('2d'); octx.drawImage(img, 0, 0, w, h);
    const data = octx.getImageData(0, 0, w, h).data;

    const pts = [];
    const step = Math.max(2, Math.floor(w / 240)); // density
    for (let yy = 0; yy < h; yy += step) {
      for (let xx = 0; xx < w; xx += step) {
        const i = ((yy | 0) * w + (xx | 0)) * 4;
        const a = data[i + 3];
        if (a > 130) pts.push({
          x: Math.random() * cvs.width, y: Math.random() * cvs.height,
          tx: x + xx, ty: y + yy, life: 0
        });
      }
    }

    let t0 = null;
    function frame(t) {
      if (!t0) t0 = t;
      ctx.clearRect(0, 0, cvs.width, cvs.height);

      // faint base image
      ctx.globalAlpha = 0.18;
      ctx.drawImage(img, x, y, w, h);
      ctx.globalAlpha = 1;

      for (const p of pts) {
        p.x += (p.tx - p.x) * 0.08;
        p.y += (p.ty - p.y) * 0.08;
        ctx.fillStyle = 'rgba(255,220,240,.9)';
        ctx.fillRect(p.x, p.y, 2, 2);
      }
      if ((t - t0) < 1600) requestAnimationFrame(frame);
      else shimmer();
    }
    requestAnimationFrame(frame);

    function shimmer() {
      let t = 0;
      (function loop() {
        ctx.clearRect(0, 0, cvs.width, cvs.height);
        ctx.globalAlpha = 0.18;
        ctx.drawImage(img, x, y, w, h);
        ctx.globalAlpha = 1;

        for (const p of pts) {
          const nx = Math.sin((p.tx + p.ty + t) * 0.002) * 0.6;
          const ny = Math.cos((p.tx - p.ty - t) * 0.002) * 0.6;
          ctx.fillStyle = 'rgba(255,210,230,.95)';
          ctx.fillRect(p.tx + nx, p.ty + ny, 2, 2);
        }
        t += 1.2;
        requestAnimationFrame(loop);
      })();
    }
  };
}

/* =============== 3D Book logic =============== */
(() => {
  function $(s){ return document.querySelector(s); }

  function initBook3D(){
    const wrap       = $('#bookWrap');
    const book3d     = $('#book3d');
    const ribbon     = $('#ribbon');
    const sealBtn    = $('#sealBtn');
    const coverRight = $('#coverRight');

    const leftPg     = $('#leftPage');
    const rightPg    = $('#rightPage');
    const rightInner = $('#rightInner');
    const rightText  = $('#rightText');
    const leftText   = $('#leftText');
    const flip       = $('#flipSheet');
    const dotsBox    = $('#dots');
    const hint       = $('#bookHint');
    const quill      = $('#quill');

    if (!wrap || !ribbon || !sealBtn || !coverRight || !leftPg || !rightPg ||
        !rightInner || !rightText || !flip || !dotsBox || !hint || !quill) return;

    // --- the lines that are written on the right page ---
    const LINES = [
      'No expectations ‚Äî\njust good wishes,\nevery day. üåô‚ú®',
      'If you need distance, take it;\nI‚Äôll still be quietly in your corner. üïØÔ∏è',
      'Consistency over drama ‚Äî\nI‚Äôll be here, same energy. üîÅ',
      'Madamji, keep the smile;\nthe rest will sort itself. üôÇ',
      'Even a 1% chance?\nI‚Äôll show up with 100% effort,\nno noise. üí™',
      'Tea + calm on standby ‚Äî\nsay the word or don‚Äôt;\nI‚Äôll read the vibe. ‚òïüòå',
      'Your pace, your rules;\nI‚Äôm not in a rush. üê¢'
    ];

    // dots under the book
    dotsBox.innerHTML = '';
    LINES.forEach((_,i)=>{
      const d = document.createElement('i');
      if(i===0) d.classList.add('on');
      dotsBox.appendChild(d);
    });
    const setDots = i => [...dotsBox.children].forEach((d,k)=>d.classList.toggle('on', k===i));

    // typewriter with moving quill (RIGHT page only)
    function writeWithQuill(containerEl, textEl, text, speed=22){
      return new Promise(resolve=>{
        textEl.textContent = '';
        quill.style.opacity = '1';

        // split by chars but keep linebreaks
        const chars = [...text];
        let i = 0;

        function step(){
          if(i>=chars.length){
            quill.style.opacity = '0';
            resolve();
            return;
          }
          const ch = chars[i++];
          const span = document.createElement('span');
          span.textContent = ch;
          textEl.appendChild(span);

          // position the quill to the caret
          const sRect = span.getBoundingClientRect();
          const cRect = containerEl.getBoundingClientRect();
          const x = sRect.right - cRect.left;
          const y = sRect.bottom - cRect.top;

          requestAnimationFrame(()=>{
            quill.style.transform = `translate(${x}px, ${y-18}px) rotate(-16deg)`;
          });

          setTimeout(step, (ch===' ' || ch==='\n') ? speed*0.6 : speed);
        }
        step();
      });
    }

    function clearRight(){ rightText.textContent=''; quill.style.opacity='0'; }
    function clearLeft(){  leftText && (leftText.textContent=''); }

    let idx=0, opened=false, turning=false;

    async function showIndex(i){
      setDots(i);
      clearLeft();
      rightText.textContent='';
      await writeWithQuill(rightInner, rightText, LINES[i], 22);
    }

    // flower shower for fun
    function flowerShower(){
      const emojis = ['üå∏','üåº','üíÆ','üå∑','üíê'];
      const N = 26;
      for(let i=0;i<N;i++){
        const s = document.createElement('span');
        s.textContent = emojis[(Math.random()*emojis.length)|0];
        s.style.position='absolute';
        s.style.left = (Math.random()*wrap.clientWidth)+'px';
        s.style.top = '-24px';
        s.style.fontSize = '20px';
        s.style.filter='drop-shadow(0 6px 10px rgba(0,0,0,.35))';
        wrap.appendChild(s);
        const drift = (Math.random()*2-1)*80, dur = 2200 + Math.random()*1600;
        s.animate(
          [{transform:'translate(0,-24px)',opacity:.95},
           {transform:`translate(${drift}px, ${wrap.clientHeight+40}px) rotate(${Math.random()*120-60}deg)`,opacity:.1}],
          {duration:dur, easing:'ease-in'}
        ).finished.finally(()=>s.remove());
      }
    }

    // unwrap ribbon ‚Üí open cover ‚Üí write first line
    async function openBook(){
      if(opened || wrap.classList.contains('opening')) return;
      wrap.classList.add('opening');
      try{ navigator.vibrate && navigator.vibrate(10); }catch{}
      try{ window.playChime && playChime(); }catch{}

      // 1) animate ribbon away
      ribbon.classList.add('unwrap');
      await new Promise(r => setTimeout(r, 600)); // match CSS .55s
      ribbon.remove();

      // 2) swing the right cover (CSS handles transform when .open is on wrap)
      wrap.classList.add('open');
      book3d?.setAttribute('aria-hidden','false');

      // 3) hint + first page
      opened = true;
      wrap.classList.remove('opening');
      hint.textContent = 'Tap right page for next, left page to go back.';
      flowerShower();
      await showIndex(idx);
    }

    // seal ‚Äì pointer + click + keyboard
    function triggerOpen(){ openBook(); }
    ['click','pointerup','touchend'].forEach(ev=>{
      sealBtn.addEventListener(ev, triggerOpen, {passive:false});
    });
    sealBtn.addEventListener('keydown', e=>{
      if(e.key==='Enter' || e.key===' '){ e.preventDefault(); triggerOpen(); }
    });

    // turn FORWARD (right page)
    rightPg.addEventListener('click', ()=>{
      if(!opened || turning) return;
      turning = true;

      const snap = rightPg.querySelector('.pageInner').cloneNode(true);
      snap.querySelector('#quill')?.remove();
      flip.innerHTML = '';
      flip.appendChild(snap);
      flip.classList.remove('reverse');
      flip.classList.add('show');

      clearRight();
      requestAnimationFrame(()=> flip.classList.add('animating')); // ‚Üí left

      flip.addEventListener('animationend', async ()=>{
        idx = (idx+1) % LINES.length;
        flip.classList.remove('animating','show');
        await showIndex(idx);
        turning = false;
      }, {once:true});
    }, {passive:true});

    // turn BACK (left page)
    leftPg.addEventListener('click', ()=>{
      if(!opened || turning) return;
      turning = true;

      const snap = rightPg.querySelector('.pageInner').cloneNode(true);
      snap.querySelector('#quill')?.remove();
      flip.innerHTML = '';
      flip.appendChild(snap);
      flip.classList.add('show','reverse'); // reverse keyframes

      clearRight();
      void flip.offsetWidth; // reflow to ensure reverse animation runs

      flip.addEventListener('animationend', async ()=>{
        idx = (idx-1+LINES.length) % LINES.length;
        flip.classList.remove('reverse','show');
        await showIndex(idx);
        turning = false;
      }, {once:true});
    }, {passive:true});
  }

  // boot
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initBook3D, {once:true});
  } else {
    initBook3D();
  }
})();
/* ---------- fireworks (final + entry burst) ---------- */
function fireworksOnCanvas(cId, duration=12000, quick=false){
  const c=$(cId), a=c.getContext('2d');
  function fit(){ c.width=innerWidth; c.height=innerHeight } fit(); addEventListener('resize',fit);
  const ps=[];
  function add(x,y,vx,vy,col){ ps.push({x,y,vx,vy,col,life:70+Math.random()*30}); }
  function hv(t){ const x=16*Math.sin(t)**3, y=13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t); return {x, y:-y}; }
  function burst(x,y,col,heart=true){
    const n=heart?140:90;
    for(let i=0;i<n;i++){
      if(heart){
        const t=i/n*Math.PI*2, v=hv(t), m=Math.hypot(v.x,v.y)||1, s=2.2+Math.random()*2.4;
        add(x,y,(v.x/m)*s,(v.y/m)*s,col);
      } else {
        const ang=Math.PI*2*i/n, s=2+Math.random()*3;
        add(x,y,Math.cos(ang)*s,Math.sin(ang)*s,col);
      }
    }
  }
  let req;
  (function tick(){
    a.clearRect(0,0,c.width,c.height);
    for(let i=ps.length-1;i>=0;i--){
      const p=ps[i]; p.x+=p.vx; p.y+=p.vy; p.vy+=0.03; p.life--;
      a.fillStyle=`rgba(${p.col},${Math.max(0,p.life/100)})`; a.fillRect(p.x,p.y,2,2);
      if(p.life<=0) ps.splice(i,1);
    }
    req=requestAnimationFrame(tick);
  })();
  function boom(){
    const x=Math.random()*c.width*.9+c.width*.05, y=Math.random()*c.height*.4+c.height*.1;
    const cols=['255,200,221','255,168,194','201,167,255','246,208,110'];
    burst(x,y,cols[(Math.random()*cols.length)|0],Math.random()<.7);
  }
  if(quick){ for(let i=0;i<4;i++) setTimeout(boom,i*300); }
  const iv=setInterval(boom,1300);
  setTimeout(()=>{ clearInterval(iv); cancelAnimationFrame(req); a.clearRect(0,0,c.width,c.height); }, duration);
}
let fwStarted=false;
new IntersectionObserver(es=>{
  es.forEach(e=>{
    if(e.isIntersecting && !fwStarted){ fwStarted=true; fireworksOnCanvas('#fire'); }
  });
},{threshold:.42}).observe($('#final'));

/* ---------- gift rain ---------- */
$('#gift')?.addEventListener('click',()=>{
  try{navigator.vibrate&&navigator.vibrate(14);}catch{}
  const icons=['üß∏','üç´','üíó','üíû','‚ú®','üå∏','üç¨','ü™î','üßø','üåº'];
  const D=5200,t0=performance.now();
  (function drop(){
    if(performance.now()-t0>D) return;
    const s=document.createElement('span');
    s.textContent=icons[(Math.random()*icons.length)|0];
    s.style.position='fixed'; s.style.top='-40px'; s.style.left=(Math.random()*innerWidth)+'px';
    s.style.fontSize='32px'; s.style.zIndex='60'; document.body.appendChild(s);
    const drift=(Math.random()*2-1)*80,time=2400+Math.random()*1800;
    s.animate(
      [{transform:'translate(0,-40px)',opacity:.95},
       {transform:`translate(${drift}px, ${innerHeight+60}px)`,opacity:.1}],
      {duration:time,easing:'ease-in'}
    );
    setTimeout(()=>s.remove(),time+60);
    requestAnimationFrame(drop);
  })();
});

/* ---------- save final promise as PNG ---------- */
$('#savePNG')?.addEventListener('click',()=>{
  const name=$('#herName')?.textContent||'You';
  const text=$('#promiseLine')?.textContent||'With love.';
  const w=1200,h=630, cn=document.createElement('canvas');
  cn.width=w; cn.height=h; const ctx=cn.getContext('2d');
  const grad=ctx.createLinearGradient(0,0,0,h);
  grad.addColorStop(0,getComputedStyle(document.body).getPropertyValue('--bg1')||'#0c1022');
  grad.addColorStop(1,getComputedStyle(document.body).getPropertyValue('--bg2')||'#14102e');
  ctx.fillStyle=grad; ctx.fillRect(0,0,w,h);
  ctx.fillStyle='rgba(255,255,255,.08)'; for(let i=0;i<200;i++){ ctx.fillRect(Math.random()*w,Math.random()*h,2,2); }
  ctx.fillStyle=getComputedStyle(document.body).getPropertyValue('--accent')||'#ff9ccc';
  ctx.font='700 44px "Fraunces", "Playfair Display", serif'; ctx.textAlign='center';
  ctx.fillText('Happy Birthday, '+name, w/2, h/2-20);
  ctx.fillStyle=getComputedStyle(document.body).getPropertyValue('--ink')||'#eaf2ff';
  ctx.font='400 28px Quicksand, Poppins, system-ui, sans-serif';
  function wrapText(text, maxWidth, lineHeight, y){
    const words=text.split(' '); let line=''; for(let n=0;n<words.length;n++){ const test=line+words[n]+' '; const mw=ctx.measureText(test).width;
      if(mw>maxWidth && n>0){ ctx.fillText(line, w/2, y); line=words[n]+' '; y+=lineHeight; } else line=test; }
    ctx.fillText(line, w/2, y);
  }
  wrapText(text, 900, 36, h/2+28);
  const a=document.createElement('a'); a.href=cn.toDataURL('image/png'); a.download=`Promise-${name}.png`; a.click();
});

/* ---------- ambience (tiny chimes) ---------- */
let ac, master;
function ensureAudioCtx(){ if(ac) return; ac=new (window.AudioContext||window.webkitAudioContext)(); master=ac.createGain(); master.gain.value=0.0; master.connect(ac.destination); }
function startAmbience(){
  try{
    ensureAudioCtx(); ac.resume&&ac.resume();
    const g=ac.createGain(); g.gain.value=0.0; g.connect(master);
    function flute(freq, t0, dur){
      const o=ac.createOscillator(); o.type='sine'; o.frequency.value=freq;
      const v=ac.createOscillator(); v.frequency.value=5; const vGain=ac.createGain(); vGain.gain.value=2; v.connect(vGain); vGain.connect(o.frequency);
      const eg=ac.createGain(); eg.gain.setValueAtTime(0.0001,t0);
      eg.gain.linearRampToValueAtTime(0.10,t0+.4); eg.gain.linearRampToValueAtTime(0.05,t0+.8); eg.gain.exponentialRampToValueAtTime(0.0001,t0+dur);
      o.connect(eg); eg.connect(g); o.start(t0); v.start(t0); o.stop(t0+dur+.05); v.stop(t0+dur+.05);
    }
    function bell(t){
      [1,2.01,2.98,4.2].forEach((m,i)=>{ const o=ac.createOscillator(); o.frequency.value=660*m; const eg=ac.createGain();
        eg.gain.setValueAtTime(0.0001,t); eg.gain.exponentialRampToValueAtTime(0.06/(i+1),t+.02); eg.gain.exponentialRampToValueAtTime(0.0001,t+1.2+i*0.2);
        o.connect(eg); eg.connect(g); o.start(t); o.stop(t+1.6+i*0.2);
      });
    }
    const start=ac.currentTime+.1; const phrase=t=>{[440,494,523,587,523,494,440].forEach((f,i)=>flute(f/2,t+i*.9,1.2)); bell(t+2.7);};
    phrase(start); setInterval(()=>phrase(ac.currentTime+.1),5000);
    master.gain.cancelScheduledValues(ac.currentTime); master.gain.linearRampToValueAtTime(0.08, ac.currentTime+1.2);
    g.gain.linearRampToValueAtTime(0.08, ac.currentTime+1.2);
  }catch{}
}
function playChime(){ try{ ensureAudioCtx(); const o=ac.createOscillator(), g=ac.createGain(); o.type='sine'; o.frequency.value=880; g.gain.value=0.0001; o.connect(g); g.connect(master);
  const t=ac.currentTime; g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(0.1,t+0.02); g.gain.exponentialRampToValueAtTime(0.0001,t+0.4); o.start(t); o.stop(t+0.42);}catch{} }

/* ---------- Local MP3 controls ---------- */
function playBgSongFadeIn(){
  const a = $('#bgSong'); if(!a) return Promise.resolve();
  a.muted=false; a.volume=0;
  const p=a.play(); if(!p||typeof p.then!=='function') return Promise.resolve();
  return p.then(()=>{
    let v=0, target=0.85, step=0.02;
    const id=setInterval(()=>{ v+=step; a.volume=Math.min(target,v); if(v>=target) clearInterval(id); },80);
  }).catch(()=>Promise.resolve());
}
function pauseBgSongFadeOut(){
  const a=$('#bgSong'); if(!a) return;
  let v=a.volume, step=0.04; const id=setInterval(()=>{ v-=step; a.volume=Math.max(0,v); if(v<=0){ clearInterval(id); a.pause(); } },60);
}
function toggleSong(){ const a=$('#bgSong'); if(!a) return; if(a.paused) playBgSongFadeIn(); else pauseBgSongFadeOut(); }
document.getElementById('toggleSongBtn')?.addEventListener('click', toggleSong);

/* ---------- Welcome Gate ---------- */

let __enteredGate = false;
async function enterGate(){
  if (__enteredGate) return;
  __enteredGate = true;

  try { await (window.playBgSongFadeIn?.() || Promise.resolve()); } catch {}
  try { window.startAmbience?.(); } catch {}

  // quick entry fireworks if present
  try {
    const fe = document.getElementById('fireEnter');
    if (fe) {
      fe.style.opacity = '1';
      window.fireworksOnCanvas && fireworksOnCanvas('#fireEnter', 5000, true);
      setTimeout(()=>{ fe.style.opacity = '0'; }, 5200);
    }
  } catch {}

  // finally hide gate (guaranteed)
  const gate = document.getElementById('gate');
  if (gate) {
    gate.classList.add('hide');
    document.body.classList.remove('gated');
    setTimeout(()=>{ try{ gate.remove(); }catch{} }, 500);
  }
}

/* ===================== 3D MODE (background) ===================== */
(() => {
  if(!window.THREE) return;
  const btn = document.getElementById('toggle3D');
  const canvas = document.getElementById('three3d');
  let renderer, scene, camera, stars, rafId, hearts=[], clock, extras=[];

  function init3D(){
    if(renderer) return;
    renderer = new THREE.WebGLRenderer({ canvas, alpha:true, antialias:true });
    renderer.setPixelRatio(Math.min(2, window.devicePixelRatio||1));
    resize();
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 1000);
    camera.position.set(0,0,28);
    clock = new THREE.Clock();

    // star field
    const starGeo = new THREE.BufferGeometry();
    const N = 1400; const pos = new Float32Array(N*3);
    for(let i=0;i<N;i++){ pos[i*3]=(Math.random()-0.5)*200; pos[i*3+1]=(Math.random()-0.5)*140; pos[i*3+2]=(Math.random()-0.5)*200; }
    starGeo.setAttribute('position', new THREE.BufferAttribute(pos,3));
    const starMat = new THREE.PointsMaterial({ size:1.3, color: new THREE.Color('#ffd2ea'), transparent:true, opacity:0.9 });
    stars = new THREE.Points(starGeo, starMat); scene.add(stars);

    // extras
    const knotMat = new THREE.MeshBasicMaterial({ color:0xffb3d7, wireframe:true, transparent:true, opacity:0.22 });
    for(let i=0;i<3;i++){
      const g = new THREE.TorusKnotGeometry(2.2+i*0.5, 0.5, 120, 18);
      const m = new THREE.Mesh(g, knotMat.clone());
      m.position.set((i-1)*4, (i%2?-2:2), -4-i*2); scene.add(m); extras.push(m);
    }
    const sparkleGeo = new THREE.BufferGeometry();
    const S=400, spos=new Float32Array(S*3);
    for(let i=0;i<S;i++){ spos[i*3]=(Math.random()-0.5)*30; spos[i*3+1]=(Math.random()-0.5)*20; spos[i*3+2]=(Math.random()-0.5)*30; }
    sparkleGeo.setAttribute('position', new THREE.BufferAttribute(spos,3));
    const sparkle = new THREE.Points(sparkleGeo, new THREE.PointsMaterial({ size:0.6, color:0xffffff, transparent:true, opacity:0.8 }));
    scene.add(sparkle); extras.push(sparkle);

    scene.fog = new THREE.FogExp2(0x0e1022, 0.006);

    let mx=0,my=0; window.addEventListener('mousemove', e=>{ mx=(e.clientX/innerWidth-.5)*2; my=(e.clientY/innerHeight-.5)*2; });

    const animate=()=>{
      const t=clock.getElapsedTime();
      stars.rotation.y=t*0.02;
      extras.forEach((m,i)=>{ m.rotation.x += 0.002*(i+1); m.rotation.y += 0.003*(i+1); });
      camera.position.x += (mx*4 - camera.position.x)*0.02;
      camera.position.y += (-my*2 - camera.position.y)*0.02;

      for(let i=hearts.length-1;i>=0;i--){
        const p=hearts[i]; p.v.add(p.g); p.m.position.add(p.v); p.life--;
        p.m.material.opacity = Math.max(0, p.life/120);
        if(p.life<=0){ scene.remove(p.m); p.m.geometry.dispose(); p.m.material.dispose(); hearts.splice(i,1); }
      }
      renderer.render(scene,camera); rafId=requestAnimationFrame(animate);
    };
    animate(); window.addEventListener('resize', resize);
  }
  function resize(){
    if(!renderer) return;
    renderer.setSize(innerWidth, innerHeight, false);
    camera && (camera.aspect=innerWidth/innerHeight, camera.updateProjectionMatrix());
  }
  function burstHearts(col='#ff8fb1'){
    if(!renderer) return;
    const count=120;
    for(let i=0;i<count;i++){
      const geo=new THREE.PlaneGeometry(0.8,0.8);
      const mat=new THREE.MeshBasicMaterial({ color:new THREE.Color(col), transparent:true, opacity:1, side:THREE.DoubleSide });
      const m=new THREE.Mesh(geo,mat);
      const t=(i/count)*Math.PI*2;
      const x=1.6*Math.pow(Math.sin(t),3);
      const y=1.3*Math.cos(t)-0.5*Math.cos(2*t)-0.2*Math.cos(3*t)-0.1*Math.cos(4*t);
      m.position.set(x*4, y*4, (Math.random()-0.5)*4);
      scene.add(m);
      const v=new THREE.Vector3(x, y, (Math.random()-0.5)).normalize().multiplyScalar(0.08+Math.random()*0.14);
      hearts.push({ m, v, g:new THREE.Vector3(0,-0.001,0), life:120+Math.random()*30 });
    }
  }
  document.getElementById('gift')?.addEventListener('click', ()=> burstHearts('#ffd86e'));

  function enable3D(){
    if(prefersReduced){ alert('3D mode respects reduced-motion and is off.'); return; }
    btn.classList.add('active'); localStorage.setItem('threeEnabled','1');
    init3D(); burstHearts(); setTimeout(()=>burstHearts('#c9a7ff'),2200);
  }
  function disable3D(){
    btn.classList.remove('active'); localStorage.removeItem('threeEnabled');
    if(rafId) cancelAnimationFrame(rafId);
    if(renderer){
      renderer.dispose(); renderer.forceContextLoss && renderer.forceContextLoss();
      window.removeEventListener('resize', resize);
    }
    if(scene){
      scene.traverse(o=>{
        if(o.geometry) o.geometry.dispose?.();
        if(o.material){ (Array.isArray(o.material)?o.material:[o.material]).forEach(m=>m.dispose?.()); }
      });
    }
    renderer=scene=camera=stars=clock=null; hearts=[]; extras=[];
    const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
    gl && gl.getExtension('WEBGL_lose_context')?.loseContext();
  }

  btn?.addEventListener('click', ()=> (renderer ? disable3D() : enable3D()));
  if(localStorage.getItem('threeEnabled')==='1' && !prefersReduced) enable3D();
})();

/* ===================== 3D PHOTO RING (overlay) ===================== */
(() => {
  if(!window.THREE) return;
  const overlay = document.getElementById('ring3d');
  const canvas  = document.getElementById('ringCanvas');
  const btnOpen = document.getElementById('openRing3D');

  let renderer, scene, camera, ringGroup, rafId, dragging=false, lastX=0;

  function openRing3D(){
    if(!Array.isArray(PHOTOS) || PHOTOS.length===0){
      alert('Add her photos in the PHOTOS array to use the 3D ring.'); return;
    }
    overlay.style.display='flex';
    initRing();
  }
  function closeRing3D(){
    overlay.style.display='none';
    if(rafId) cancelAnimationFrame(rafId);
    if(renderer){ renderer.dispose(); renderer.forceContextLoss && renderer.forceContextLoss(); }
    if(scene){
      scene.traverse(o=>{
        if(o.geometry) o.geometry.dispose?.();
        if(o.material){ (Array.isArray(o.material)?o.material:[o.material]).forEach(m=>m.dispose?.()); }
        if(o.texture) o.texture.dispose?.();
      });
    }
    renderer=scene=camera=ringGroup=null;
  }
  window.closeRing3D = closeRing3D;

  function initRing(){
    renderer = new THREE.WebGLRenderer({ canvas, antialias:true });
    renderer.setPixelRatio(Math.min(2, window.devicePixelRatio||1));
    size();
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(55, canvas.clientWidth/canvas.clientHeight, 0.1, 1000);
    camera.position.set(0,0,18);

    const amb = new THREE.AmbientLight(0xffffff, 0.9); scene.add(amb);

    ringGroup = new THREE.Group(); scene.add(ringGroup);
    const loader = new THREE.TextureLoader(); loader.crossOrigin = 'anonymous';
    const R = 10, n = Math.min(12, PHOTOS.length);
    for(let i=0;i<n;i++){
      const tex = loader.load(PHOTOS[i].src); tex.minFilter = THREE.LinearFilter;
      const mat = new THREE.MeshBasicMaterial({ map: tex, side: THREE.DoubleSide });
      const geo = new THREE.PlaneGeometry(6, 9);
      const mesh = new THREE.Mesh(geo, mat);
      const a = (i/n)*Math.PI*2;
      mesh.position.set(Math.cos(a)*R, 0, Math.sin(a)*R);
      mesh.lookAt(0,0,0);
      ringGroup.add(mesh);
    }

    canvas.addEventListener('pointerdown', e=>{ dragging=true; lastX=e.clientX; });
    canvas.addEventListener('pointermove', e=>{
      if(!dragging) return; const dx = (e.clientX - lastX); lastX = e.clientX; ringGroup.rotation.y += dx * 0.005;
    });
    window.addEventListener('pointerup', ()=> dragging=false);

    const animate = ()=>{
      if(!dragging) ringGroup.rotation.y += 0.004;
      renderer.render(scene, camera);
      rafId = requestAnimationFrame(animate);
    };
    animate();
    window.addEventListener('resize', size);
  }

  function size(){
    const w = overlay.clientWidth || innerWidth;
    const h = overlay.clientHeight || innerHeight;
    renderer?.setSize(w*0.94, h*0.82, false);
    camera && (camera.aspect = (w*0.94)/(h*0.82), camera.updateProjectionMatrix());
  }

  btnOpen?.addEventListener('click', openRing3D);
})();

/* 3D paper tilt (works on mouse + touch) */
(() => {
  const paper = document.getElementById('finalPaper');
  if(!paper) return;

  const max = 10; // degrees
  let rect;

  function setTilt(clientX, clientY){
    rect = rect || paper.getBoundingClientRect();
    const x = (clientX - (rect.left + rect.width/2)) / (rect.width/2);
    const y = (clientY - (rect.top  + rect.height/2)) / (rect.height/2);
    paper.style.setProperty('--ry', `${x*max}deg`);
    paper.style.setProperty('--rx', `${-y*max}deg`);
  }

  function resetTilt(){ paper.style.setProperty('--rx','0deg'); paper.style.setProperty('--ry','0deg'); rect=null; }

  paper.addEventListener('mousemove', e => setTilt(e.clientX, e.clientY), {passive:true});
  paper.addEventListener('mouseleave', resetTilt, {passive:true});

  // touch support
  paper.addEventListener('touchmove', e => {
    const t = e.touches[0]; if(t) setTilt(t.clientX, t.clientY);
  }, {passive:true});
  paper.addEventListener('touchend', resetTilt, {passive:true});
})();

</script>
</body>
</html>



